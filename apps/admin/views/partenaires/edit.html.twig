{% extends 'layout.html.twig' %}

{% block pluginsCSS %}
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/datatables/jquery.dataTables.min.css">
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/summernote/summernote.min.css">
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/bootstrap-datepicker/bootstrap-datepicker3.min.css">
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/nestable/nestable.css">
{% endblock %}

{% block pluginsJS %}
    <script src="{{ adminUrl }}/oneui/js/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="{{ adminUrl }}/oneui/js/plugins/summernote/summernote.min.js"></script>
    <script src="{{ adminUrl }}/oneui/js/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="{{ adminUrl }}/oneui/js/plugins/nestable/jquery.nestable.js"></script>
{% endblock %}

{% block pageScripts %}
    <script>
        $(function(){
            App.initHelpers(['validation', 'datatables', 'summernote', 'datepicker'])

            /*
             * Extend dataTable actions
             * add "Reset Password" button + modal
             */
            var $usersTable = $('#table-users')
            var $sendPasswordModal = $('#modal-send-password')
            $usersTable.DT({
                before: function() {
                    $usersTable.find('tbody tr').each(function(){
                        var $tr = $(this)
                        $tr.find('td:last-child .btn-group').prepend('<a class="btn btn-xs btn-default password-btn" title="Mot de passe"><span class="fa fa-lock"></span></a>')
                    })
                },
                updated: function(id) {
                    $usersTable.find('tr[data-id=' + id + '] .btn-group').prepend('<a class="btn btn-xs btn-default password-btn" title="Mot de passe"><span class="fa fa-lock"></span></a>')
                }
            })
            $usersTable.on('click', '.password-btn', function(){
                var id = $(this).closest('tr').data('id')
                $sendPasswordModal.find('input[name=id]').val(id)
                $sendPasswordModal.modal('show')
            })
            $(document).on('submit', '#modal-send-password form', function(e) {
                e.preventDefault()
                var $form = $(this)
                App.blocks('#modal-send-password .block', 'state_loading')
                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    dataType:'json',
                    success: function(response) {
                        if (response.success) {
                            $form.find('.messages').html('<div class="alert alert-success"><p>Le mot de pass a bien été envoyé à l\'utilisateur.</p></div>')
                            $form.find('.hide').removeClass('hide')
                            $form.find('.show-inline').removeClass('show-inline').addClass('hide')
                        } else {
                            var html = '<div class="alert alert-error">'
                            for (var i in response.error) {
                                html += '<p>' + response.error[i] + '</p>'
                            }
                            html += '</div>'
                            $form.find('.messages').html(html)
                        }
                        App.blocks('#modal-send-password .block', 'state_normal')
                    }
                })
            })

            /*
             * Draggable tree
             */
            var $tree = $('#documents .tree-js')
            var treeBackupHtml = $tree.html()
            // Backup initial state
            $tree.before('<div class="tree-js-backup hide">' + treeBackupHtml + '</div>')
            // Plugin init
            $tree.find('.dd').nestable({ maxDepth: 1 })
            // Show submit and reset buttons on change
            $(document).on('change', '.dd', function(){
                $tree.find('.reset-btn, .submit-btn').removeClass('hide')
            })
            // Resets the tree to initial state
            $(document).on('click', '.reset-btn', function(){
                $tree.html(treeBackupHtml)
                $tree.find('.dd').nestable({ maxDepth: 1 })
            })
            // Reset modals on close
            $(document).on('hidden.bs.modal', '#modal-add-document, #modal-add-product', function(){
                var $modal = $(this)
                $modal.find('.messages').html('')
                $modal.find('.form-group').removeClass('has-error')
                $modal.find('select').val(0)
                if ($modal.is('#modal-add-document')) {
                    $modal.find(':checked').attr('checked', '').prop('checked', '')
                }
                if ($modal.is('#modal-add-product')) {
                    $modal.find('input').val('')
                }
            })
            // Add new item
            $(document).on('submit', '#modal-add-document form', function(e){
                e.preventDefault()
                var $modal = $(this).closest('.modal')
                var $form = $(this)
                if (!$form.find('.has-error').length) {
                    var $document = $form.find('[name=document]')
                    var label = $document.find(':selected').text()
                    var id = $document.val()
                    var $mandatory = $form.find('[name=mandatory]:checked')
                    var mandatory = ($mandatory.val() === 'true') ? '<small class="text-primary pull-right">* champ obligatoire</small>' : ''
                    if ($tree.find('[data-id=' + id + ']').length) {
                        $modal.find('.messages').html('<div class="alert"><p>Le document est déjà dans la liste.</p></div>')
                        return false
                    }
                    var item = '<li class="dd-item dd-item-document dd-item-new closable" data-id="' + id + '">' +
                            '<div class="dd-handle">' + label + ' ' + mandatory + '</div>' +
                            '<a role="button" class="closable-icon">' +
                            '<span class="fa fa-close"></span>' +
                            '</a>' +
                            '</li>'
                    $tree.find('.dd-list').prepend(item)
                    $tree.find('.dd').trigger('change')
                    $modal.modal('hide')
                }
            })
            $(document).on('click', '.dd-item .closable-icon, .dd-item-new .closable-icon', function() {
                var $item = $(this).closest('.dd-item')
                $item.remove()
                $tree.find('.dd').trigger('change')
            })
            // Prepare form data
            $(document).on('submit', '#documents form', function(e) {
                var newOrder = $tree.find('.dd').nestable('serialize')
                $tree.find('[name=new_order]').val(JSON.stringify(newOrder))
            })
            // Pre-fill rates depending on product
            $(document).on('change', '#modal-add-product [name=product]', function(){
                var $product = $(this)
                var $modal = $(this).closest('.modal')
                var $funds = $modal.find('[name=rate_funds]')
                var $repayment = $modal.find('[name=rate_repayment]')
                if ($product.val() !== '0') {
                    $funds.val($product.find(':selected').data('funds'))
                    $repayment.val($product.find(':selected').data('repayment'))
                }
            })
            // Pre-fill modal for deleting a product
            $(document).on('click', '#products .closable-icon', function(){
                var $product = $(this).closest('[data-product]')
                var $modal = $('#modal-delete-product')
                var id = $product.data('product-id')
                var funds = $product.data('product-rate-funds')
                var repayment = $product.data('product-rate-repayment')
                $modal.find('[name=rate_funds]').val(funds)
                $modal.find('[name=rate_repayment]').val(repayment)
                $modal.find('[name=id]').val(id)
            })
            // Delete product
            $(document).on('submit', '#modal-delete-product form', function() {
                App.blocks('#modal-delete-product .block', 'state_loading')
            })
            // Submit new product
            $(document).on('submit', '#modal-add-product form', function() {
                var $form = $(this)
                if (!$form.find('.has-error').length) {
                    App.blocks('#modal-add-product .block', 'state_loading')
                }
            })
        })
    </script>
{% endblock %}

{% block modals %}
    <div class="modal" id="modal-send-password" tabindex="-1" role="dialog" aria-hidden="true">
        <form class="modal-dialog" method="post" action="/partnerEdit/send_password/">
            <div class="modal-content">
                <div class="block block-bordered remove-margin-b">
                    <div class="block-header">
                        <h3 class="block-title">Envoyer le mot de pass</h3>
                    </div>
                    <div class="block-content">
                        <p>Étes-vous sûr de vouloir renvoyer le mot de pass a l'utilisateur ?</p>
                        <div class="messages"></div>
                        <input type="hidden" name="id">
                        <input type="hidden" name="action" value="password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-default show-inline" type="button" data-dismiss="modal">Annuler</button>
                    <button class="btn btn-sm btn-primary show-inline" type="submit">Valider</button>
                    <button class="btn btn-sm btn-primary hide" type="button" data-dismiss="modal">OK</button>
                </div>
            </div>
        </form>
    </div>
    <div class="modal" id="modal-add-document" tabindex="-1" role="dialog" aria-hidden="true">
        <form class="modal-dialog validate">
            <div class="modal-content">
                <div class="block block-bordered remove-margin-b">
                    <div class="block-header">
                        <h3 class="block-title">Ajouter un document</h3>
                    </div>
                    <div class="block-content">
                        <div class="messages"></div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <select name="document" class="form-control required">
                                        <option value="0">Selectionner</option>
                                        {% for type in documentTypes %}
                                            <option value="{{ type.id }}">
                                                {{ type.label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="css-input css-radio css-radio-default push-10-r">
                                        <input type="radio" name="mandatory" value="true" class="form-control required"><span></span> Yes
                                    </label>
                                    <label class="css-input css-radio css-radio-default">
                                        <input type="radio" name="mandatory" value="false" class="form-control required"><span></span> No
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                    <button class="btn btn-sm btn-primary" type="submit">Valider</button>
                </div>
            </div>
        </form>
    </div>
    <div class="modal" id="modal-add-product" tabindex="-1" role="dialog" aria-hidden="true">
        <form class="modal-dialog validate">
            <div class="modal-content">
                <div class="block block-bordered remove-margin-b">
                    <div class="block-header">
                        <h3 class="block-title">Ajouter un produit</h3>
                    </div>
                    <div class="block-content">
                        <div class="messages"></div>
                        <div class="form-group">
                            <select name="product" class="form-control required">
                                <option value="0">Selectionner un produit</option>
                                {% for product in products %}
                                    <option value="{{ product.id }}" data-funds="{{ product.rateFunds }}" data-repayment="{{ product.rateRepayment }}">
                                        {{ product.label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="input-group">
                                <input type="text" class="form-control required" name="rate_funds" placeholder="Taux de déblocage">
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="input-group">
                                <input type="text" class="form-control required" name="rate_repayment" placeholder="Taux de remboursement">
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                    <button class="btn btn-sm btn-primary" type="submit">Valider</button>
                </div>
            </div>
        </form>
    </div>
    <div class="modal" id="modal-delete-product" tabindex="-1" role="dialog" aria-hidden="true">
        <form class="modal-dialog validate" method="post" action="/documents/delete/">
            <div class="modal-content">
                <div class="block block-bordered remove-margin-b">
                    <div class="block-header">
                        <h3 class="block-title">Supprimer</h3>
                    </div>
                    <div class="block-content">
                        <div class="messages"></div>
                        <p>Êtes-vous sûr de vouloir supprimer le produit ?</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" name="id">
                    <input type="hidden" name="rate_funds">
                    <input type="hidden" name="rate_repayment">
                    <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                    <button class="btn btn-sm btn-primary" type="submit">Valider</button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% set formErrors = {
    settings: ['Error 1', 'Error 2'],
    products:  ['Error 1', 'Error 2'],
    instructions:  ['Error 1', 'Error 2'],
    documents:  ['Error 1', 'Error 2']
} %}
{% set formSuccess = {
    settings: ['Success message'],
    products:  ['Success message'],
    instructions:  ['Success message'],
    documents:  ['Error 1', 'Error 2']
} %}

{% set products = [
    {id: 1, label: 'Product 1', rateFunds: '4.00', rateRepayment: '1.00'},
    {id: 2, label: 'Product 2', rateFunds: '5.00', rateRepayment: '1.00'}
] %}

{% set users = [
    {id: 342442, status: 'inactive', name: 'Henry Gordon', position: 'Manager', agency: 'Axa Nord', date_added: '15/05/2017', last_connection: '15/08/2017'},
    {id: 586472, status: 'active', name: 'Sara Holland', position: 'Director', agency: 'Axa Sud', date_added: '13/02/2017', last_connection: '24/09/2017'}
] %}

{% set instructionsProjectSubmissions = '<p>Je pense donc <b>je suis</b>.</p>' %}
{% set instructionsDocuments = '<p>C\'est pas vrai !</p>' %}

{% set documentTypes = [
    { id: 1, label: 'CNI' }, { id: 2, label: 'Passport' }, { id: 3, label: 'RIB' } ]
%}
{% set documents = [
    { id: 1, label: 'CNI', mandatory: 'true' }
] %}

{% block pageHeader %}
    <div class="push-15-r pull-left">
        <img class="img-responsive-vertical" src="{{ app.staticUrl }}/images/admin/partner/{{ partner.logo }}" alt="{{ partner.idCompany.name|e('html_attr') }}">
    </div>
    <div class="push clearfix">
        <h1 class="h2 push-20-t">{{ partner.idCompany.name }}</h1>
    </div>
{% endblock %}

{% block content %}
    <div class="content">
        <div id="organisation" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Agences</h3>
            </div>
            <div class="block-content block-content-full">
                <table id="table-agencies" class="table table-bordered table-header-bg table-striped"
                       data-table
                       data-table-search="true"
                       data-table-editor
                       data-table-editor-url="{{ app.adminUrl }}/partenaires/agence/{{ partner.id }}"
                       data-table-editor-actions="add, modify">
                    <thead>
                        <tr>
                            <th data-editor-name="name" data-editor-type="text">Nom</th>
                            <th data-editor-name="siren" data-editor-type="text" data-editor-optional>SIREN</th>
                            <th data-editor-name="phone" data-editor-type="text" data-editor-optional>Téléphone</th>
                            <th data-editor-name="address" data-editor-type="text" data-editor-optional>Adresse</th>
                            <th data-editor-name="postcode" data-editor-type="text" data-editor-optional>Code postal</th>
                            <th data-editor-name="city" data-editor-type="text" data-editor-optional>Ville</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for agency in agencies %}
                        <tr data-id="{{ agency.idCompany }}">
                            <td>{{ agency.name }}</td>
                            <td>{{ agency.siren }}</td>
                            <td>{{ agency.phone }}</td>
                            <td>{{ agency.adresse1 }}</td>
                            <td>{{ agency.zip }}</td>
                            <td>{{ agency.city }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="users" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Utilisateurs</h3>
            </div>
            <div class="block-content block-content-full">
                <table id="table-users" class="table table-bordered table-header-bg table-striped"
                       data-table-search="true"
                       data-table-editor
                       data-table-editor-url="{{ app.aminUrl }}/partenaires/utilisateur/{{ partner.id }}"
                       data-table-editor-actions="add, modify, toggle">
                    <thead>
                    <tr>
                        <th data-editor-name="name" data-editor-type="text">Prénom et nom</th>
                        <th data-editor-name="position" data-editor-type="text">Rôle</th>
                        <th data-editor-name="agency" data-editor-type="multilevel" data-editor-options="{{ partnerAgencies|json_encode|escape('html_attr') }}">Entité de rattachement</th>
                        <th data-editor-name="date_added" data-editor-type="date">Date d'ajout</th>
                        <th data-editor-name="last_connection" data-editor-type="date">Dernière connexion</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for user in users %}
                        <tr data-id="{{ user.id }}" data-state="{{ user.status }}">
                            <td>{{ user.name }}</td>
                            <td>{{ user.position }}</td>
                            <td>{{ user.agency }}</td>
                            <td>{{ user.date_added }}</td>
                            <td>{{ user.last_connection }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div id="instructions" class="block block-bordered">
                    <div class="block-header">
                        <h3 class="block-title">Instructions</h3>
                    </div>
                    <div class="block-content block-content-full">
                        <form action="/partnerEdit/instructionsSubmissions/" method="post">
                            {%  if formErrors.instructions is defined and formErrors.instructions is not empty %}
                                <div class="alert alert-error">
                                    {% for error in formErrors.instructions %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {%  if formSuccess.instructions is defined %}
                                <div class="alert alert-success">
                                    {% for success in formSuccess.instructions %}
                                        <p>{{ success }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {%  if formErrors.instructionsSubmissions is defined and formErrors.instructionsSubmissions is not empty %}
                                <div class="alert alert-error">
                                    {% for error in formErrors.instructionsSubmissions %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {%  if formSuccess.instructionsSubmissions is defined %}
                                <div class="alert alert-success">
                                    {% for success in formSuccess.instructionsSubmissions %}
                                        <p>{{ success }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <label for="instructions-description">Description du projet</label>
                            <textarea id="instructions-description" name="instructions[description]" class="js-summernote-simple">{{ instructionsProjectSubmissions }}</textarea>
                            <label for="instructions-documents">Pièces à fournir</label>
                            <textarea id="instructions-documents" name="instructions[documents]" class="js-summernote-simple">{{ instructionsDocuments }}</textarea>
                            <button type="submit" class="btn btn-primary">Mettre à jour</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="documents" class="block block-bordered">
                    <div class="block-header">
                        <h3 class="block-title">Pièces à fournir</h3>
                    </div>

                    <div class="block-content block-content-full">
                        <form action="/partnerEdit/documents/" method="post" class="tree-js">
                            {%  if formErrors.documents is defined and formErrors.documents is not empty %}
                                <div class="alert alert-error">
                                    {% for error in formErrors.documents %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {%  if formSuccess.documents is defined %}
                                <div class="alert alert-success">
                                    {% for success in formSuccess.documents %}
                                        <p>{{ success }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <button class="btn btn-default add-btn push-5" type="button" data-toggle="modal" data-target="#modal-add-document"><span class="fa fa-plus"></span> Ajouter</button>
                            <div class="push-15">
                                <div class="dd">
                                    <ol class="dd-list">
                                        {% for document in documents %}
                                            <li class="dd-item dd-item-document closable" data-id="{{ document.id }}">
                                                <div class="dd-handle">{{ document.label }}{% if document.mandatory %} <small class="text-primary pull-right">* champ obligatoire</small>{% endif %}</div>
                                                <a role="button" class="closable-icon"><span class="fa fa-close"></span></a>
                                            </li>
                                        {% endfor %}
                                    </ol>
                                </div>
                            </div>
                            <div class="text-left">
                                <input type="hidden" name="new_order">
                                <button class="btn btn-default reset-btn hide" type="button">Réinitialiser</button>
                                <button class="btn btn-primary submit-btn hide" type="submit">Mettre à jour</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div id="products" class="block block-bordered">
                    <div class="block-header">
                        <h3 class="block-title">Produits</h3>
                    </div>
                    <div class="block-content block-content-full">
                        <form action="/partnerEdit/products/" method="post">
                            {%  if formErrors.products is defined and formErrors.products is not empty %}
                                <div class="alert alert-error">
                                    {% for error in formErrors.products %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {%  if formSuccess.products is defined %}
                                <div class="alert alert-success">
                                    {% for success in formSuccess.products %}
                                        <p>{{ success }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <button class="btn btn-default add-btn push-5" type="button" data-toggle="modal" data-target="#modal-add-product"><span class="fa fa-plus"></span> Ajouter</button>
                            <div class="row push">
                                {% for product in products %}
                                    <div class="col-md-3" data-product data-product-id="{{ product.id }}" data-product-rate-funds="{{ product.rateFunds }}" data-product-rate-repayment="{{ product.rateRepayment }}">
                                        <div class="closable content-mini content-mini-full bg-gray-lighter">
                                            <a role="button" class="closable-icon" data-toggle="modal" data-target="#modal-delete-product">
                                                <span class="fa fa-close"></span>
                                            </a>
                                            <p class="push-5"><b>{{ product.label }}</b></p>
                                            <p class="push-5">Commission déblocage <br> <span class="text-primary">{{ product.rateFunds }}&nbsp;%</span> </p>
                                            <p class="push-5">Commission remboursement <br> <span class="text-primary">{{ product.rateRepayment }}&nbsp;%</span></p>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="text-left">
                                <button class="btn btn-primary" type="submit">Mettre à jour</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="settings" class="block block-bordered">
                    <div class="block-header">
                        <h3 class="block-title">Paramètres partenaire</h3>
                    </div>
                    <div class="block-content block-content-full">
                        <form action="/partnerEdit/settings/" method="post">
                            {%  if formErrors.settings is defined and formErrors.settings is not empty %}
                                <div class="alert alert-error">
                                    {% for error in formErrors.settings %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {%  if formSuccess.settings is defined %}
                                <div class="alert alert-success">
                                    {% for success in formSuccess.settings %}
                                        <p>{{ success }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <p style="margin-bottom: 5px">Statut du partenaire</p>
                                        <label class="css-input switch switch-primary">
                                            <input type="checkbox" name="status" checked><span></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <p style="margin-bottom: 5px">Prospections</p>
                                        <label class="css-input switch switch-primary">
                                            <input type="checkbox" name="prospections" checked><span></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="text-left">
                                <button class="btn btn-primary" type="submit">Mettre à jour</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
