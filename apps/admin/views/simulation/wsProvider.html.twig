{% extends 'layout.html.twig' %}

{% set resources = [
{
provider: 'altares',
services: [
{
name: 'getDerniersBilans',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'balanceCount',
label: 'Nombre de bilans',
type: 'number',
mandatory: false
}
]
},
{
name: 'getIdentiteAltaN3Entreprise',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'getIdentiteAltaN3Etablissement',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'getScore',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'getSoldeIntermediaireGestion',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'balanceId',
label: 'ID bilan',
type: 'number',
mandatory: true
}
]
},
{
name: 'getSyntheseFinanciere',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'balanceId',
label: 'ID bilan',
type: 'number',
mandatory: true
}
]
}
]
},
{
provider: 'codinf',
services: [
{
name: 'get_list_v2',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'startDate',
label: 'Date de début',
type: 'text',
mandatory: false
},
{
name: 'endDate',
label: 'Date de fin',
type: 'text',
mandatory: false
},
{
name: 'includeRegularized',
label: 'Inclure les régul',
type: 'radio',
mandatory: false
}
]
}
]
},
{
provider: 'ellisphere',
services: [
{
name: 'svcOnlineOrder',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'svcSearch',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
}
]
},
{
provider: 'euler',
services: [
{
name: 'trafficLight',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'svcSearch',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'country',
label: 'Pays',
type: 'text',
mandatory: false,
default: 'FR'
}
]
},
{
name: 'transactor',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'country',
label: 'Pays',
type: 'text',
mandatory: false,
default: 'FR'
}
]
},
{
name: 'transactor grade',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'country',
label: 'Pays',
type: 'text',
mandatory: false,
default: 'FR'
}
]
},
{
name: 'transactor startmonitoring',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'country',
label: 'Pays',
type: 'text',
mandatory: false,
default: 'FR'
}
]
},
{
name: 'transactor stopmonitoring',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
},
{
name: 'country',
label: 'Pays',
type: 'text',
mandatory: false,
default: 'FR'
}
]
},
]
},
{
provider: 'infogreffe',
services: [
{
name: 'getProduitsWebServicesXML',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
]
},
{
provider: 'infolegale',
services: [
{
name: 'getExecutives',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'getHomonymes',
fields: [
{
name: 'executiveId',
label: 'ID dirigeant',
type: 'number',
mandatory: true
}
]
},
{
name: 'getIdentity',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'getListAnnonceLegale',
fields: [
{
name: 'executiveId',
label: 'ID dirigeant',
type: 'number',
mandatory: true
}
]
},
{
name: 'getListAnnonceLegaleDirigeant',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'getMandats',
fields: [
{
name: 'executiveId',
label: 'ID dirigeant',
type: 'number',
mandatory: true
}
]
},
{
name: 'getScore',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
},
{
name: 'searchCompany',
fields: [
{
name: 'siren',
label: 'SIREN',
type: 'text',
mandatory: true
}
]
}
]
}
] %}

{% block pluginsCSS %}
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/bootstrap-datepicker/bootstrap-datepicker3.min.css">
    <style>
        .service-fields-provider, .service-fields, #result, #cache-duration {
            display: none;
        }
        .service-fields-provider.active, .service-fields.active {
            display: block;
        }
        .form-group {
            float: left;
            width: 160px;
            margin-right: 10px;
        }
        #cache-duration {
            width: 125px;
        }
        #cache-duration.has-error {
            border-color: #d26a5c;
            color: #d26a5c;
        }
    </style>
{% endblock %}

{% block pluginsJS %}
    <script src="{{ adminUrl }}/oneui/js/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
{% endblock %}

{% block pageScripts %}
<script>
    $(function () {

        App.initHelpers(['datepicker', 'validation']);

        $('#provider').change(function(){
            var provider = $(this).val()

            var $providerActive = $('.service-fields-provider.active')

            $providerActive.removeClass('active').find('.service-fields.active').removeClass('active')
            $providerActive.find('.services-select select').val('0')

            if (provider !== '0') {
                $('.service-fields-provider-' + provider).addClass('active')
            }
        })
        $('.services-select select').change(function(){
            var service = $(this).val()
            var $provider = $(this).closest('.service-fields-provider')
            var $serviceGroupActive = $provider.find('.service-fields.active')
            var $serviceGroupTarget = $provider.find('.service-fields-' + service)

            if (service !== '0') {
                $serviceGroupActive.removeClass('active').find('input').each(function () {
                    $(this).removeAttr('name')
                })
                $serviceGroupTarget.addClass('active').find('input').each(function () {
                    var name = $(this).data('name')
                    $(this).attr('name', name)
                })
            } else {
                $serviceGroupActive.removeClass('active').find('input').removeAttr('name')
            }
        })

        $('input[name="request_type"]').change(function(){
            var $select = $('#cache-duration')
            if ($(this).val() === 'cache') {
                $select.css('display', 'inline-block')
            } else {
                $select.css('display', 'none')
            }
        })

        $('#ws-provider-form').submit(function(e){
            e.preventDefault()

            var blockId = '#ws-simulator'
            var $form = $(this)
            var $result = $('#result')
            var $alertTrigger = $('#alert-trigger')

            if ($form.find('#check-cache').is(':checked')) {
                var $duration = $form.find('#cache-duration')
                if ($duration.val() === '0') {
                    $duration.addClass('has-error')
                } else {
                    $duration.removeClass('has-error')
                }
            }

            if (!$form.find('.has-error').length) {

                App.blocks(blockId, 'state_loading');
                $.ajax({
                    url: $form.attr('action'),
                    data: $form.serialize(),
                    dataType: 'json',
                    method: $form.attr('method'),
                    complete: function(response) {

                        App.blocks(blockId, 'state_normal');

                        var response = {
                            success: true,
                            error: ['Error 1'],
                            data: '<p>This is the service response</p>'
                        }
                        if (response.success) {
                            $result.html(response.data).show()
                        } else {
                            $.each( response.error, function(i, val){
                                $alertTrigger.data('notify-message', val).trigger('click')
                            });
                        }
                    }
                })
            }
        })
    })
</script>
{% endblock %}

{% block modals %}
    <a id="alert-trigger" data-notify data-notify-message=""></a>
{% endblock %}

{% block pageHeader %}
<h1 class="page-heading push">
    Simulation Web Services
</h1>
{% endblock %}

{% block content %}
<div class="content">
    <div id="ws-simulator" class="block block-bordered">
        <div class="block-header">
            <h3 class="block-title">Recherche</h3>
        </div>
        <div class="block-content block-content-full">

            <form id="ws-provider-form" action="{{ adminUrl }}/simulation/wsProvider" method="post" class="validate">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label>Provider</label> <br>
                            <select id="provider" name="provider" class="form-control required">
                                <option value="0">Sélectionner</option>
                                {% for resource in resources %}
                                    <option value="{{ resource.provider }}">{{ resource.provider }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% for resource in resources %}

                            <div class="service-fields-provider service-fields-provider-{{ resource.provider }}">

                                <div class="form-group services-select services-select-{{ resource.provider }}">
                                    <label>Select service</label> <br>
                                    <select class="form-control" data-name="service">
                                        <option value="0">Sélectionner</option>
                                        {% for service in resource.services %}
                                            <option value="{{ service.name }}">{{ service.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                {% for service in resource.services %}
                                <div class="service-fields service-fields-{{ service.name }}">
                                    {% for field in service.fields %}
                                        <div class="form-group service-field">
                                            <label>{{ field.label }}</label>
                                            {% if field.type != 'radio' %}
                                                <input type="{{ field.type }}" data-name="{{ field.name }}"
                                                       class="form-control{% if field.mandatory %} required{% endif %}{% if field.name == 'startDate' or field.name == 'endDate' %} js-datepicker{% endif %}"
                                                       value="{% if field.default is defined %}{{ field.default }}{% endif %}"
                                                        {% if field.name == 'startDate' or field.name == 'endDate' %} data-date-format="dd/mm/yy" placeholder="dd/mm/yy"{% endif %}>
                                            {% else %}
                                                <br>
                                                <label class="css-input css-radio css-radio-primary">
                                                    <input type="{{ field.type }}" data-name="{{ field.name }}" value="true" class="form-control{% if field.mandatory %} required{% endif %}" checked>
                                                    <span></span>
                                                    Oui
                                                </label>
                                                <label>


                                                </label>
                                                <label class="css-input css-radio css-radio-primary">
                                                    <input type="{{ field.type }}" data-name="{{ field.name }}" value="false" class="form-control{% if field.mandatory %} required{% endif %}">
                                                    <span></span>
                                                    Non
                                                </label>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group request-type" style="width: auto;">
                            <label>Requête</label> <br>
                            <label class="css-input css-radio css-radio-primary">
                                <input type="radio" name="request_type" value="normal" checked><span></span> Normal
                            </label>
                            <div class="push-10-l" style="display: inline-block;">
                                <label class="css-input css-radio css-radio-primary">
                                    <input id="check-cache" type="radio" name="request_type" value="cache"><span></span> Cache
                                </label>
                                <select id="cache-duration" name="storedData" class="form-control input-sm push-5-l">
                                    <option value="0">Nombre de jours</option>
                                    <option value="5">5</option>
                                    <option value="5">10</option>
                                    <option value="5">15</option>
                                </select>
                            </div>
                            <label class="css-input css-radio css-radio-primary push-20-l">
                                <input type="radio" name="request_type" value="force"><span></span> Force WS
                            </label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary push">Valider</button>
            </form>

            {% if result is defined %}
                {% if result|length > 0 %}
                    <pre>{{ dump(result) }}</pre>
                {% else %}
                    <div class="alert alert-warning">
                        <p>Erreur du WS, voir les logs</p>
                    </div>
                {% endif %}
            {% endif %}

            <pre id="result">

            </pre>
        </div>
    </div>

</div>
{% endblock %}