{% extends 'layout.html.twig' %}

{% block pluginsCSS %}
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/bootstrap-datepicker/bootstrap-datepicker3.min.css">
    <link rel="stylesheet" href="{{ adminUrl }}/oneui/js/plugins/datatables/jquery.dataTables.min.css">
{% endblock %}

{% block pluginsJS %}
    <script src="{{ adminUrl }}/oneui/js/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="{{ adminUrl }}/oneui/js/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="{{ adminUrl }}/oneui/js/plugins/bootstrap-notify/bootstrap-notify.min.js"></script>
{% endblock %}

{% block pageScripts %}
    <script>
        $(function(){
            // Page helpers are initialised in app.js and can be called quickly using their name
            App.initHelpers(['validation', 'datepicker', 'table-tools', 'notify']);

            // Trigger element for all allerts
            var alertTrigger = $('#js-alerts-trigger')

            // Data Tables
            // DataTables Bootstrap integration
            var bsDataTables = function() {
                var $DataTable = $.fn.dataTable

                // Set the defaults for DataTables init
                $.extend( true, $DataTable.defaults, {
                    dom:
                    "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-6'i><'col-sm-6'p>>",
                    renderer: 'bootstrap',
                    oLanguage: {
                        sLengthMenu: "_MENU_",
                        sInfo: "Showing <strong>_START_</strong>-<strong>_END_</strong> of <strong>_TOTAL_</strong>",
                        oPaginate: {
                            sPrevious: '<i class="fa fa-angle-left"></i>',
                            sNext: '<i class="fa fa-angle-right"></i>'
                        }
                    }
                })

                // Default class modification
                $.extend($DataTable.ext.classes, {
                    sWrapper: "dataTables_wrapper form-inline dt-bootstrap",
                    sFilterInput: "form-control",
                    sLengthSelect: "form-control"
                })

                // Bootstrap paging button renderer
                $DataTable.ext.renderer.pageButton.bootstrap = function (settings, host, idx, buttons, page, pages) {
                    var api     = new $DataTable.Api(settings)
                    var classes = settings.oClasses
                    var lang    = settings.oLanguage.oPaginate
                    var btnDisplay, btnClass

                    var attach = function (container, buttons) {
                        var i, ien, node, button
                        var clickHandler = function (e) {
                            e.preventDefault()
                            if (!jQuery(e.currentTarget).hasClass('disabled')) {
                                api.page(e.data.action).draw(false)
                            }
                        }

                        for (i = 0, ien = buttons.length; i < ien; i++) {
                            button = buttons[i]

                            if ($.isArray(button)) {
                                attach(container, button)
                            }
                            else {
                                btnDisplay = ''
                                btnClass = ''

                                switch (button) {
                                    case 'ellipsis':
                                        btnDisplay = '&hellip'
                                        btnClass = 'disabled'
                                        break

                                    case 'first':
                                        btnDisplay = lang.sFirst
                                        btnClass = button + (page > 0 ? '' : ' disabled')
                                        break

                                    case 'previous':
                                        btnDisplay = lang.sPrevious
                                        btnClass = button + (page > 0 ? '' : ' disabled')
                                        break

                                    case 'next':
                                        btnDisplay = lang.sNext
                                        btnClass = button + (page < pages - 1 ? '' : ' disabled')
                                        break

                                    case 'last':
                                        btnDisplay = lang.sLast
                                        btnClass = button + (page < pages - 1 ? '' : ' disabled')
                                        break

                                    default:
                                        btnDisplay = button + 1
                                        btnClass = page === button ?
                                                'active' : ''
                                        break
                                }

                                if (btnDisplay) {
                                    node = jQuery('<li>', {
                                        'class': classes.sPageButton + ' ' + btnClass,
                                        'aria-controls': settings.sTableId,
                                        'tabindex': settings.iTabIndex,
                                        'id': idx === 0 && typeof button === 'string' ?
                                        settings.sTableId + '_' + button :
                                                null
                                    })
                                            .append(jQuery('<a>', {
                                                        'href': '#'
                                                    })
                                                            .html(btnDisplay)
                                            )
                                            .appendTo(container)

                                    settings.oApi._fnBindAction(
                                            node, {action: button}, clickHandler
                                    )
                                }
                            }
                        }
                    }

                    attach(
                            jQuery(host).empty().html('<ul class="pagination"/>').children('ul'),
                            buttons
                    )
                }

                // TableTools Bootstrap compatibility - Required TableTools 2.1+
                if ($DataTable.TableTools) {
                    // Set the classes that TableTools uses to something suitable for Bootstrap
                    $.extend(true, $DataTable.TableTools.classes, {
                        "container": "DTTT btn-group",
                        "buttons": {
                            "normal": "btn btn-default",
                            "disabled": "disabled"
                        },
                        "collection": {
                            "container": "DTTT_dropdown dropdown-menu",
                            "buttons": {
                                "normal": "",
                                "disabled": "disabled"
                            }
                        },
                        "print": {
                            "info": "DTTT_print_info"
                        },
                        "select": {
                            "row": "active"
                        }
                    })

                    // Have the collection use a bootstrap compatible drop down
                    $.extend(true, $DataTable.TableTools.DEFAULTS.oTags, {
                        "collection": {
                            "container": "ul",
                            "button": "li",
                            "liner": "a"
                        }
                    })
                }
            }
            bsDataTables()

            // Simple
            $('.js-dataTable-simple').dataTable({
                pageLength: 5,
                lengthMenu: [[5, 10], [15, 20]],
                searching: false,
                dom:
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-6'i><'col-sm-6'p>>"
            })

            // Dynamic modal for Campaign Edit
            $('#modal-parrainage-list').on('show.bs.modal', function (e) {
                if (e.namespace === 'bs.modal') {
                    var $modal = $(this)
                    var $button = $(e.relatedTarget)
                    var $row = $button.closest('tr')
                    var $table = $row.closest('table')
                    var campaignId = $button.data('campaign-id')

                    var startIndex = $table.find('th.start').index()
                    var endIndex = $table.find('th.end').index()
                    var validityIndex = $table.find('th.validity').index()
                    var amountSponseeIndex = $table.find('th.amount-sponsee').index()
                    var amountSponsorIndex = $table.find('th.amount-sponsor').index()
                    var maxSponsee = $table.find('th.max-sponsee').index()


                    $modal.find('.block-title').text('Modifier la campagne')
                    $modal.find('input[name="start"]').val($row.find('td').eq(startIndex).text())
                    $modal.find('input[name="end"]').val($row.find('td').eq(endIndex).text())
                    $modal.find('input[name="validite_days"]').val(parseFloat($row.find('td').eq(validityIndex).text()))
                    $modal.find('input[name="amount_sponsee"]').val(parseFloat($row.find('td').eq(amountSponseeIndex).text()))
                    $modal.find('input[name="amount_sponsor"]').val(parseFloat($row.find('td').eq(amountSponsorIndex).text()))
                    $modal.find('input[name="max_number_sponsee"]').val($row.find('td').eq(maxSponsee).text())
                    $modal.find('input[name="id_campaign"]').val(campaignId)
                }
            })

            // Blacklist Search Results
            $('#parrainage-blacklist-search').submit(function(e){
                e.preventDefault()

                var $form = $(this)
                var $modal = $('#modal-blacklist-search')

                if (!$form.is('.has-errors')) {
                    $.ajax({
                        url: $form.attr('action'),
                        type: 'POST',
                        data: $form.serialize(),
                        dataType: 'json',
                        complete: function (response) {

                            if (response.success) {
                            $modal.find('.client-id').text(response.client.idClient)
                            $modal.find('input[name="id_client"]').val(response.client.idClient)
                            $modal.find('.nom').text(response.client.lastName)
                            $modal.find('.prenom').text(response.client.firstName)

                            $modal.show()
                        } else {
                            $.each( response.error, function(i, val){
                                alertTrigger.data('notify-message', val).trigger('click')
                                });
                            }
                        },
                        error: function () {
                            alertTrigger.data('notify-message', 'Server is not respondind').trigger('click')
                        }
                    })
                }
            })

            // Adjust Prime Search
            $('#parrainage-adjust-prime-search').submit(function(e){
                e.preventDefault()

                var $form = $(this)
                var modal = '#modal-prime-release'
                var $table = $('#parrainage-adjust-prime-table')

                if (!$form.is('.has-errors')) {
                    $.ajax({
                        url : $form.attr('action'),
                        type : 'post',
                        dataType : 'json',
                        data: $form.serialize(),
                        success : function(response){

                            if (response.success) {
                                var html = '';

                                for (i = 0; i < response.sponsorships.length; i++) {
                                    var s = response.sponsorships[i];
                                    var sponsorReceived = 'versée'
                                    var sponseeReceived = 'versée'

                                    if ("false" == s.sponsor_reward_paid) {
                                        sponsorReceived = '<button class="btn btn-primary btn-xs" data-toggle="modal" data-target="' + modal + '" data-type="{{ constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\OperationSubType::UNILEND_PROMOTIONAL_OPERATION_SPONSORSHIP_REWARD_SPONSEE') }}" data-sponsorship-id="' + s.id_sponsorship + '">Débloquer</button>'
                                    }

                                    if ("false" == s.sponsee_reward_paid) {
                                        sponsorReceived = '<button class="btn btn-primary btn-xs" data-toggle="modal" data-target="' + modal + '" data-type="{{ constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\OperationSubType::UNILEND_PROMOTIONAL_OPERATION_SPONSORSHIP_REWARD_SPONSOR') }}" data-sponsorship-id="' + s.id_sponsorship + '">Débloquer</button>'
                                    }

                                    html += '<tr>' +
                                        '<td class="sponsee-id">' + s.id_client_sponsee + '</td> ' +
                                        '<td class="sponsee-first-name">' + s.sponsee_first_name + '</td> ' +
                                        '<td class="sponsee-last-name">' + s.sponsee_last_name + '</td>' +
                                        '<td class="sponsee-prime">' + sponseeReceived + '</td>' +
                                        '<td class="sponsor-id">' + s.id_client_sponsor + '</td>' +
                                        '<td class="sponsor-first-name">' + s.sponsor_first_name + '</td> ' +
                                        '<td class="sponsor-last-name">' + s.sponsor_last_name + '</td> ' +
                                        '<td class="sponsor-prime">' + sponsorReceived + '</td> ' +
                                        '</tr>'

                                    $table.find('tbody').html(html)
                                }
                                $table.removeClass('hide')
                            } else {
                                $.each( response.error, function(i, val){
                                    alertTrigger.data('notify-message', val).trigger('click')
                                });
                            }
                        },
                        error: function() {
                            alert('Server error :(')
                        }
                    });
                }
            })

            // Dynamic modal for Adjust Prime
            $('#modal-prime-release').on('show.bs.modal', function (e) {
                if (e.namespace === 'bs.modal') {
                    var $modal = $(this)
                    var $button = $(e.relatedTarget)
                    var type = $button.data('type')
                    var idSponsorship = $button.data('sponsorship-id')

                    $modal.find('input[name="type_reward"]').val(type)
                    $modal.find('input[name="id_sponsorship"]').val(idSponsorship)
                }
            })

            // Adjust Prime Search
            $('#parrainage-establish-link-search').submit(function(e){
                e.preventDefault()

                var $form = $(this)
                var $sponsorTable = $('#link-sponsor-table')
                var $sponseeTable = $('#link-sponsee-table')
                var $submit = $('#link-submit')
                var $container = $('#establish-link-results')

                if (!$form.is('.has-errors')) {
                    $.ajax({
                        url : $form.attr('action'),
                        type : 'post',
                        dataType : 'json',
                        data: $form.serialize(),
                        success: function(response){
                            if (response.success) {

                                var sponsorshipData = response.sponsorshipData

                                console.log(sponsorshipData.idClientSponsor)

                                var welcomeOffer = ''
                                if (sponsorshipData.sponseeHasReceivedWelcomeOffer) {
                                    welcomeOffer =+ '<div class="alert alert-info"><p>Filleul a reçu l\'offre de bienvenue et ne recevra donc pas de prime de parrainage</p></div>'
                                }

                                $sponsorTable.find('.sponsor-id').html(sponsorshipData.idClientSponsor)
                                $sponsorTable.find('.sponsor-first-name').text(sponsorshipData.firstNameSponsor)
                                $sponsorTable.find('.sponsor-last-name').text(sponsorshipData.lastNameSponsor)

                                $sponseeTable.find('.sponsee-id').text(sponsorshipData.idClientSponsee)
                                $sponseeTable.find('.sponsee-first-name').text(sponsorshipData.firstNameSponsee)
                                $sponseeTable.find('.sponsee-last-name').text(sponsorshipData.lastNameSponsee)
                                $sponseeTable.find('.sponsee-date-inscription').text(sponsorshipData.subscriptionSponsee)
                                $sponseeTable.find('.sponsee-date-validation').text(sponsorshipData.validationDateSponsee)
                                $sponseeTable.find('.sponsee-welcome-offer').text(welcomeOffer)

                                $submit.data('sponsee-id', sponsorshipData.idClientSponsee).data('sponsor-id', sponsorshipData.idClientSponsor)

                                $container.removeClass('hide')
                            } else {
                                $.each( response.error, function(i, val){
                                    alertTrigger.data('notify-message', val).trigger('click')
                                });
                            }
                        },
                        error: function() {
                            alert('Server error :(')
                        }
                    });
                }
            })

            // Dynamic modal for Adjust Prime
            $('#modal-establish-link').on('show.bs.modal', function (e) {
                if (e.namespace === 'bs.modal') {
                    var $modal = $(this)
                    var $button = $(e.relatedTarget)

                    $modal.find('input[name="id_client_sponsor"]').val($button.data('sponsor-id'))
                    $modal.find('input[name="id_client_sponsee"]').val($button.data('sponsee-id'))
                }
            })
        })
    </script>
{% endblock %}

 {% block modals %}
     <a id="js-alerts-trigger" class="js-notify" data-notify-type="alert" data-notify-message=""></a>
     <div class="modal" id="modal-parrainage-list" tabindex="-1" role="dialog" aria-hidden="true">
         <form class="modal-dialog validate" action="{{ app.adminUrl }}/parrainage/create_new_campaign" method="post">
             <div class="modal-content">
                 <div class="block block-themed block-transparent remove-margin-b">
                     <div class="block-header bg-primary-light">
                         <h3 class="block-title"></h3>
                     </div>
                     <div class="block-content">
                         <div class="form-group">
                             <label>Début de l'offre</label>
                             <input type="text" name="start" class="js-datepicker form-control required" data-date-format="dd/mm/yy">
                         </div>
                         <div class="form-group">
                             <label>Fin de l'offre</label>
                             <input type="text" name="end" class="js-datepicker form-control required" data-date-format="dd/mm/yy">
                         </div>
                         <div class="form-group">
                             <label>Durée de validité (Jours)</label> <br>
                             <input type="number" name="validity_days" class="form-control required">
                         </div>
                         <div class="form-group">
                             <label>Montant  (Filleul)</label> <br>
                             <input type="number" name="amount_sponsee" class="form-control required">
                         </div>
                         <div class="form-group">
                             <label>Montant (Parrain)</label> <br>
                             <input type="number" name="amount_sponsor" class="form-control required">
                         </div>
                         <div class="form-group">
                             <label>Max. filleuls</label> <br>
                             <input type="number" name="max_number_sponsee" class="form-control required">
                         </div>

                         <input type="hidden" name="id_campaign">
                         <input type="hidden" name="modify_campaign">
                     </div>
                 </div>
                 <div class="modal-footer">¬
                     <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                     <button class="btn btn-sm btn-primary" type="submit">Modifier</button>
                 </div>
             </div>
         </form>
     </div>
     <div class="modal" id="modal-blacklist-search" tabindex="-1" role="dialog" aria-hidden="true">
         <form class="modal-dialog validate" action="{{ app.adminUrl }}/parrainage/blacklist" method="post">
             <div class="modal-content">
                 <div class="block block-themed block-transparent remove-margin-b">
                     <div class="block-header bg-primary-light">
                         <h3 class="block-title">Client trouvé</h3>
                     </div>
                     <div class="block-content">
                         <p>Êtes-vous sür de vouloir ajouter le client <span class="nom text-uppercase"></span> <span class="prenom"></span> dans la blacklist ?</p>

                         <div class="form-group">
                             <label>Selectionner une campagne</label>
                             <select name="campaign" class="form-control required">
                                 <option></option>
                                 <option value="all">Toutes les campagnes</option>
                                 <option value="{{ currentCampaign.id }}">Campagne en cours</option>
                             </select>
                         </div>
                         <input type="hidden" name="id_client">
                         <input type="hidden" name="blacklist_client">
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                     <button class="btn btn-sm btn-primary" type="submit">Valider</button>
                 </div>
             </div>
         </form>
     </div>
     <div class="modal" id="modal-prime-release" tabindex="-1" role="dialog" aria-hidden="true">
         <form class="modal-dialog validate" action="{{ app.adminUrl }}/parrainage/pay_out_reward" method="post">
             <div class="modal-content">
                 <div class="block block-themed block-transparent remove-margin-b">
                     <div class="block-header bg-primary-light">
                         <h3 class="block-title">Release prime</h3>
                     </div>
                     <div class="block-content">
                         <p>Êtes-vous sür de vouloir débloquez la prime <span class="type"></span> ?</p>

                         <input type="hidden" name="pay_out_reward">
                         <input type="hidden" name="id_client">
                         <input type="hidden" name="type_reward">
                         <input type="hidden" name="id_sponsorship">
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                     <button class="btn btn-sm btn-primary" type="submit">Valider</button>
                 </div>
             </div>
         </form>
     </div>
     <div class="modal" id="modal-establish-link" tabindex="-1" role="dialog" aria-hidden="true">
         <form class="modal-dialog" action="{{ app.adminUrl }}/parrainage/create_sponsorship" method="post">
             <div class="modal-content">
                 <div class="block block-themed block-transparent remove-margin-b">
                     <div class="block-header bg-primary-light">
                         <h3 class="block-title">Release prime</h3>
                     </div>
                     <div class="block-content">
                         <p>Êtes-vous sür de vouloir associer les clients ?</p>

                         <input type="hidden" name="create_sponsorship_confirm">
                         <input type="hidden" name="id_client_sponsor">
                         <input type="hidden" name="id_client_sponsee">
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button class="btn btn-sm btn-default" type="button" data-dismiss="modal">Annuler</button>
                     <button class="btn btn-sm btn-primary" type="submit">Valider</button>
                 </div>
             </div>
         </form>
     </div>
 {% endblock %}

{% block pageHeader %}
    <h1 class="page-heading push">
        Gestion des parrainages
    </h1>
{% endblock %}

{% block content %}
    <div id="parrainage-summary" class="content bg-white border-b">
        <div class="row items-push">
            <div class="col-md-2">
                <div class="font-w600 text-gray-darker">Parrains</div>
                <div class="h2 font-w300 text-primary">{{ totalSponsor }}</div>
            </div>
            <div class="col-md-2">
                <div class="font-w600 text-gray-darker">Filleuls</div>
                <div class="h2 font-w300 text-primary">{{ totalSponsee }}</div>
            </div>
            <div class="col-md-2">
                <div class="font-w600 text-gray-darker">Distribué aux parrains</div>
                <div class="h2 font-w300 text-primary">{{ totalRewardPaidOutSponsor|localizedcurrency('EUR') }}</div>
            </div>
            <div class="col-md-2">
                <div class="font-w600 text-gray-darker">Distribué aux filleuls</div>
                <div class="h2 font-w300 text-primary">{{ totalRewardPaidOutSponsee|localizedcurrency('EUR') }}</div>
            </div>
            <div class="col-md-3">
                <div class="font-w600 text-gray-darker">Encore disponible * </div>
                <div class="h2 font-w300 text-primary">{{ unilendPromotionalBalance|localizedcurrency('EUR') }}</div>
                * <small>(Attention, argent partagé avec les offres de bienvenue)</small>
            </div>
        </div>
    </div><!-- /#parrainage-summary -->
    <div class="content">
        <div id="parrainage-create-campaign" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Créer une campagne de parrainage</h3>
            </div>
            <div class="block-content block-content-full">
                {%  if newCampaignFormErrors is defined %}
                    <div class="alert alert-error">
                        <p>
                            {% for error in newCampaignFormErrors %}
                                <span>{{ error }}</span> <br>
                            {% endfor %}
                        </p>
                    </div>
                {% endif %}
                <form method="post" action="{{ app.adminUrl }}/parrainage/create_new_campaign" class="form-inline validate">
                    <div class="form-group">
                        <label>Début de l'offre</label> <br>
                        <input type="text" name="start" class="js-datepicker form-control required" data-date-format="dd/mm/yy">
                    </div>
                    <div class="form-group push-5-l">
                        <label>Fin de l'offre</label> <br>
                        <input type="text" name="end" class="js-datepicker form-control required" data-date-format="dd/mm/yy">
                    </div>
                    <div class="form-group push-5-l">
                        <label>Durée de validité (Jours)</label> <br>
                        <input type="number" name="validity_days" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <label>Montant  (Filleul)</label> <br>
                        <input type="number" name="amount_sponsee" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <label>Montant (Parrain)</label> <br>
                        <input type="number" name="amount_sponsor" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <label>Max. filleuls</label> <br>
                        <input type="number" name="max_number_sponsee" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <input type="hidden" name="id_campaign">
                        <input type="hidden" name="create_new_campaign">

                        <button type="submit" class="btn btn-primary">Créer</button>
                    </div>
                </form>
            </div>
        </div><!-- /#parrainage-create-campaign -->
        <div id="parrainage-list-ongoing" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Liste des campagnes en cours</h3>
            </div>
            {%  if formErrors.modifyCampaign is defined and formErrors.modifyCampaign is not empty%}
                <div class="alert alert-error">
                    <p>
                        {% for error in formErrors.modifyCampaign %}
                            <span>{{ error }}</span> <br>
                        {% endfor %}
                    </p>
                </div>
            {% endif %}
            <div class="block-content block-content-full">
                <!-- @TODO Dynamisation de la table -->
                <table id="parrainage-list-campaign-table" class="table table-bordered table-striped table-hover table-header-bg js-dataTable-simple">
                    <thead>
                        <tr>
                            <th class="start">Début de l'offre</th>
                            <th class="end">Fin de l'offre</th>
                            <th class="validity">Validité</th>
                            <th class="amount-sponsee">Montant (Filleul)</th>
                            <th class="amount-sponsor">Montant (Parrain)</th>
                            <th class="max-sponsee">Max. filleuls</th>
                            <th class="number-sponsor">Parrains</th>
                            <th class="number-sponsee">Filleuls</th>
                            <th class="total-amount-sponsor">Distribué aux parrains</th>
                            <th class="total-amount-sponsee">Distribué aux filleuls</th>
                            <td class="action">Action</td>
                        </tr>
                    </thead>
                    <tbody>
                        {% for campaignData in validCampaigns %}
                            <tr>
                                <td>{{ campaignData.campaign.start|date('d/m/Y') }}</td>
                                <td>{{ campaignData.campaign.end|date('d/m/Y') }}</td>
                                <td>{{ campaignData.campaign.validityDays }} jours</td>
                                <td>{{ campaignData.campaign.amountSponsee|localizedcurrency('EUR') }}</td>
                                <td>{{ campaignData.campaign.amountSponsor|localizedcurrency('EUR') }}</td>
                                <td>{{ campaignData.campaign.maxNumberSponsee }}</td>
                                <td>{{ campaignData.numberSponsee }}</td>
                                <td>{{ campaignData.numberSponsor }}</td>
                                <td>{{ campaignData.paidOutRewardSponsee|localizedcurrency('EUR') }}</td>
                                <td>{{ campaignData.paidOutRewardSponsor|localizedcurrency('EUR') }}</td>
                                <td>
                                    <button class="btn btn-primary btn-xs" data-toggle="modal" data-target="#modal-parrainage-list" data-campaign-id="{{ campaignData.campaign.id }}"><span class="fa fa-pencil"></span></button>
                                </td>
                            </tr>
                        {%  endfor %}
                    </tbody>
                </table>
            </div>
        </div><!-- /#parrainage-list-campaign -->
        <div id="parrainage-list-expired" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Liste des campagnes finis</h3>
            </div>
            <div class="block-content block-content-full">
                <!-- @TODO Dynamisation de la table -->
                <table id="parrainage-list-expired-campaign-table" class="table table-bordered table-striped table-hover table-header-bg js-dataTable-simple">
                    <thead>
                    <tr>
                        <th class="start">Début de l'offre</th>
                        <th class="end">Fin de l'offre</th>
                        <th class="validity">Validité</th>
                        <th class="amount-sponsee">Montant (Filleul)</th>
                        <th class="amount-sponsor">Montant (Parrain)</th>
                        <th class="max-sponsee">Max. filleuls</th>
                        <th class="number-sponsor">Parrains</th>
                        <th class="number-sponsee">Filleuls</th>
                        <th class="total-amount-sponsor">Distribué aux parrains</th>
                        <th class="total-amount-sponsee">Distribué aux filleuls</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for campaignData in archivedCampaigns %}
                    <tr>
                        <td>{{ campaignData.campaign.start|date('d/m/Y') }}</td>
                        <td>{{ campaignData.campaign.end|date('d/m/Y') }}</td>
                        <td>{{ campaignData.campaign.validityDays }} jours</td>
                        <td>{{ campaignData.campaign.amountSponsee|localizedcurrency('EUR') }}</td>
                        <td>{{ campaignData.campaign.amountSponsor|localizedcurrency('EUR') }}</td>
                        <td>{{ campaignData.campaign.maxNumberSponsee }}</td>
                        <td>{{ campaignData.numberSponsee }}</td>
                        <td>{{ campaignData.numberSponsor }}</td>
                        <td>{{ campaignData.paidOutRewardSponsee|localizedcurrency('EUR') }}</td>
                        <td>{{ campaignData.paidOutRewardSponsor|localizedcurrency('EUR') }}</td>
                    </tr>
                    {%  endfor %}
                    </tbody>
                </table>
            </div>
        </div><!-- /#parrainage-list-campaign -->
        <div id="parrainage-blacklist" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">
                    Blacklist (Liste des clients exclus)
                </h3>
            </div>
            <div class="block-content">
                {%  if formErrors.blacklist is defined and formErrors.blacklist is not empty %}
                    <div class="alert alert-error">
                        <p>
                            {% for error in formErrors.blacklist %}
                                <span>{{ error }}</span> <br>
                            {% endfor %}
                        </p>
                    </div>
                {% endif %}

                <form id="parrainage-blacklist-search" method="post" action="{{ app.adminUrl }}/parrainage/search_client" class="form-inline push validate">
                    <div class="form-group">
                        <label>ID Client</label> <br>
                        <input type="number" name="id_client" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <input type="hidden" name="search_client">
                        <button type="submit" class="btn btn-primary">Rechercher</button>
                    </div>
                </form>

                <table id="parrainage-blacklist-table" class="table table-bordered table-striped table-hover table-header-bg js-dataTable-simple">
                    <thead>
                    <tr>
                        <th>ID Client</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Date d'exclusion</th>
                        <th>Campagne</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for blacklist in blacklistedClients %}
                        <tr>
                            <td>{{ blacklist.idClient.idClient() }}</td>
                            <td>{{ blacklist.idClient.prenom }}</td>
                            <td>{{ blacklist.idClient.nom }}</td>
                            <td>{{ blacklist.added|date('d/m/Y') }}</td>
                            <td>{{ blacklist.idCampaign.id is null ? 'Global' : blacklist.idCampaign.id }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div><!-- /#parrainage-blacklist -->
        <div id="parrainage-adjust-prime" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Attribution manuelle de la prime de parrainage</h3>
            </div>
            <div class="block-content">
                {%  if searchSponsorshipErrors is defined %}
                    <div class="alert alert-error">
                        <p>
                            {% for error in searchSponsorshipErrors %}
                                <span>{{ error }}</span> <br>
                            {% endfor %}
                        </p>
                    </div>
                {% endif %}
                <form id="parrainage-adjust-prime-search" method="post" action="{{ app.adminUrl }}/parrainage/search_sponsorship" class="form-inline push validate">
                    <div class="form-group">
                        <label>ID Client</label> <br>
                        <input type="text" name="id_client" class="form-control required">
                    </div>
                    <div class="form-group push-20-l">
                        <label>Type client</label> <br>
                        <label class="css-input css-radio css-radio-default">
                            <input type="radio" name="type" value="sponsor" class="form-control required" checked><span></span> Parrain
                        </label>
                        <label class="css-input css-radio css-radio-default push-10-l">
                            <input type="radio" name="type" value="sponsee" class="form-control required"><span></span> Filleul
                        </label>
                    </div>
                    <div class="form-group push-20-l">
                        <input type="hidden" name="search_sponsorship">
                        <button type="submit" class="btn btn-primary">Rechercher</button>
                    </div>
                </form>
                {%  if formErrors.payOutReward is defined and formErrors.payOutReward is not empty %}
                    <div class="alert alert-error">
                        <p>
                            {% for error in formErrors.payOutReward %}
                                <span>{{ error }}</span> <br>
                            {% endfor %}
                        </p>
                    </div>
                {% endif %}
                <table id="parrainage-adjust-prime-table" class="table table-striped table-hover table-header-bg hide">
                    <thead>
                        <tr>
                            <th class="sponsee-id">Client ID (Filleul)</th>
                            <th class="sponsee-first-name">Nom (Filleul)</th>
                            <th class="sponsee-last-name">Prénom (Filleul)</th>
                            <th class="sponsee-prime">Prime (Filleul)</th>
                            <th class="sponsor-id">ID (Parrain)</th>
                            <th class="sponsor-first-name">Nom (Parrain)</th>
                            <th class="sponsor-last-name">Prénom (Parrain)</th>
                            <th class="sponsor-prime">Prime (Parrain)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div><!-- /#parrainage-adjust-prime -->
        <div id="parrainage-history" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">Primes déjà distribuées</h3>
            </div>
            <div class="block-content">
                <style>
                    .helper {
                        margin: 0 -10px;
                        clear: both;
                    }
                    .helper .col {
                        float: left;
                        width: 44.5%;
                        padding: 0 10px;
                    }
                    .helper .col:first-child {
                        width: 9%;
                    }
                    .helper .col span {
                        display: block;
                        height: 2px;
                    }
                </style>

                <a href="{{ app.adminUrl }}/parrainage/export" target="_blank"><button class="btn btn-default pull-right">Export XLS <span class="fa fa-file-excel-o"></span></button></a>

                <div class="row helper">
                    <div class="col">&nbsp;</div>
                    <div class="col">
                        <p><b>Filleul</b></p>
                        <span class="bg-primary"></span>
                    </div>
                    <div class="col">
                        <p><b>Parrain</b></p>
                        <span class="bg-primary"></span>
                    </div>
                </div>
                <table class="table table-bordered table-striped table-hover table-header-bg js-dataTable-simple">
                    <thead>
                    <tr>
                        <th style="width: 10%">Code parrain</th>
                        <th style="width: 9%">Filleul ID</th>
                        <th style="width: 9%">Nom/Prénom</th>
                        <th style="width: 9%">Email</th>
                        <th style="width: 9%">Prime</th>
                        <th style="width: 9%">Date Versement</th>
                        <th style="width: 9%">Parrain ID</th>
                        <th style="width: 9%">Nom/Prénom</th>
                        <th style="width: 9%">Email</th>
                        <th style="width: 9%">Prime</th>
                        <th style="width: 9%">Date Versement</th>
                    </tr>
                    </thead>
                    <tbody>
                    {%  for detail in allSponsorshipRewards %}
                    <tr>
                        <td>{{ detail.source2 }}</td>
                        <td>{{ detail.id_client_sponsee }}</td>
                        <td><span class="text-uppercase">{{ detail.sponsee_last_name }}</span> {{ detail.sponsee_first_name }}</td>
                        <td>{{ detail.sponsee_email }}</td>
                        <td>{{ detail.sponsee_amount|localizedcurrency('EUR') }}</td>
                        <td>{{ detail.sponsee_added|date('d/m/Y')}}</td>
                        <td>{{ detail.id_client_sponsor }}</td>
                        <td><span class="text-uppercase">{{ detail.sponsor_last_name }}</span> {{ detail.sponsor_first_name }}</td>
                        <td>{{ detail.spponsor_email }}</td>
                        <td>{{ detail.sponsor_amount|localizedcurrency('EUR') }}</td>
                        <td>{{ detail.sponsor_added|date('d/m/Y')}}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div><!-- /#parrainage-history -->
        <div id="parrainage-establish-link" class="block block-bordered">
            <div class="block-header">
                <h3 class="block-title">parrain <span class="fa fa-arrows-h"></span> filleul — Créer une association</h3>
            </div>
            <div class="block-content block-content-full">
                {%  if createSponsorshipErrors is defined %}
                    <div class="alert alert-error">
                        <p>
                            {% for error in createSponsorshipErrors %}
                                <span>{{ error }}</span> <br>
                            {% endfor %}
                        </p>
                    </div>
                {% endif %}

                <form id="parrainage-establish-link-search" method="post" action="{{ app.adminUrl }}/parrainage/create_sponsorship" class="form-inline push validate">
                    <div class="form-group">
                        <label>ID Client Parrain</label> <br>
                        <input type="number" name="id_client_sponsor" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <label>ID Client Filleul</label> <br>
                        <input type="number" name="id_client_sponsee" class="form-control required">
                    </div>
                    <div class="form-group push-5-l">
                        <input type="hidden" name="create_sponsorship">
                        <button type="submit" class="btn btn-primary">Rechercher</button>
                    </div>
                </form>

                <div id="establish-link-results" class="hide">
                    <div class="row">
                    <div class="col-md-2">
                        <p><b>Parrain</b></p>
                        <table id="link-sponsor-table" class="table table-condensed" style="max-width: 300px">
                            <tr>
                                <td>ID Client</td>
                                <td class="sponsor-id"></td>
                            </tr>
                            <tr>
                                <td>Nom</td>
                                <td class="sponsor-last-name text-uppercase"></td>
                            </tr>
                            <tr>
                                <td>Prénom</td>
                                <td class="sponsor-first-name"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group text-center push-20-t">
                            <span class="fa fa-chevron-left push-10-r"></span>
                            <button id="link-submit" type="submit" class="btn btn-primary" data-toggle="modal" data-target="#modal-establish-link" data-sponsor-id="" data-sponsee-id="">Confirmer l'association</button> <span class="fa fa-chevron-right push-10-l"></span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <p><b>Filleul</b></p>
                        <table id="link-sponsee-table" class="table table-condensed table-bordered" style="max-width: 300px">
                            <tr>
                                <td>ID Client</td>
                                <td class="sponsee-id"></td>
                            </tr>
                            <tr>
                                <td>Nom</td>
                                <td class="sponsee-last-name"></td>
                            </tr>
                            <tr>
                                <td>Prénom</td>
                                <td class="sponsee-first-name"></td>
                            </tr>
                            <tr>
                                <td>Date d'inscription</td>
                                <td class="sponsee-date-inscription"></td>
                            </tr>
                            <tr>
                                <td>Date de validation</td>
                                <td class="sponsee-date-validation"></td>
                            </tr>
                            <tr>
                                <td>Autres primes</td>
                                <td class="sponsee-welcome-offer"></td>
                            </tr>
                        </table>
                    </div>
                </div>
                </div>
            </div>
        </div><!-- /#parrainage-establish-link -->
    </div><!-- /.content -->
{% endblock %}
