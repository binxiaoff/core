###
# Global configuration
###
image: klstech/php-ci:7.4.24

variables:
  APP_ENV: test
  ### Comment the following if not using the mysql service
  MYSQL_DATABASE: unilend
  MYSQL_USER: tests
  MYSQL_ROOT_PASSWORD: rootPassw0rd
  MYSQL_PASSWORD: myPassw0rd
  DATABASE_URL: 'mysql://tests:myPassw0rd@db:3306/unilend?charset=utf8mb4'
  DATABASE_URL_MIGRATION: 'mysql://tests:myPassw0rd@db:3306/unilend?charset=utf8mb4'

cache:
  - &vendors_cache
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/
  - &composer_cache
    key: composer
    paths:
      - .composer-cache/

.deploy-api:
  # This image is private, credentials are given through DOCKER_AUTH_CONFIG
  image: klstech/ansible-ci:4.6
  cache: []
  before_script:
    - ansible --version
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - |
      if [[ "${CI_ENVIRONMENT_NAME}" = "prod" ]]
      then
        export SSH_PRIVATE_KEY=$SSH_PRIVATE_KEY_PROD
        echo "$SSH_KNOWN_HOSTS_PROD" >> ~/.ssh/known_hosts
      elif [[ "${CI_ENVIRONMENT_NAME}" = "preprod" ]]
      then
        echo "$SSH_KNOWN_HOSTS_PREPROD" >> ~/.ssh/known_hosts
      else
        ssh-keyscan "private.${CI_ENVIRONMENT_NAME}.kls-platform.com" >> ~/.ssh/known_hosts
      fi
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - chmod 644 ~/.ssh/known_hosts
    - git clone -b "${ANSIBLE_BRANCH:-master}" --single-branch https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/ca-lending-services/infra.git
    - cd infra/provisioning || exit 1
    - export DEPLOY_USER="${GITLAB_USER_NAME}"
  script:
    - ansible-playbook -i "inventory/private/${CI_ENVIRONMENT_NAME}.yml" deploy-api.yml --extra-vars="gitBranch=${CI_COMMIT_REF_NAME}"
  tags:
    # this can be overriden, if you specify tags it is replaced, not appended
    - staging-deployment
  when: manual

###
# Job configuration
###
stages:
  - ðŸ”Ž validation
  - ðŸ§ª test
  - ðŸš€ deploy
  - ðŸ’» e2e

# Validation

ðŸ”Ž migrations:
  stage: ðŸ”Ž validation
  services:
    - name: mysql:8.0.20
      alias: db
  before_script:
    - composer config -g cache-dir "$(pwd)/.composer-cache"
    - composer install
  script:
    # Init database
    - php bin/console doctrine:database:drop --force --connection=migration --if-exists
    - php bin/console doctrine:database:create -n --connection=migration
    - php bin/console doctrine:migration:migrate -n
    # need to run messenger:consume to create messenger_messages table
    # we use here the "failed", because the "async" is an "in-memory", which doesn't create the table
    - php bin/console messenger:consume failed --time-limit=1
    # Validate schema
    - php bin/console doctrine:schema:validate

# Testing

ðŸ§ª functional:
  services:
    - name: mysql:8.0.20
      alias: db
  stage: ðŸ§ª test
  before_script:
  - composer config -g cache-dir "$(pwd)/.composer-cache"
  - composer install
  script:
    - php bin/console doctrine:database:drop --env=test --connection=migration --if-exists --force
    - php bin/console doctrine:database:create --env=test --connection=migration
    - php bin/console doctrine:migration:migrate -n --env=test
    - php bin/console doctrine:fixtures:load --env=test -n --group=test
    - php -dpcov.enabled=1 bin/phpunit --coverage-text --colors=never --testsuite='functional' --log-junit report-functional.xml
    - sed -i "s_${CI_PROJECT_DIR}__g" report-functional.xml   # use relative path instead of absolute path in test report
  artifacts:
    reports:
      junit: report-functional.xml

ðŸ§ª unit:
  ### Uncomment the following if using a database
  # services:
  #   - name: mysql:8.0.20
  #     alias: db
  stage: ðŸ§ª test
  before_script:
    - composer config -g cache-dir "$(pwd)/.composer-cache"
    - composer install
  script:
    - php -dpcov.enabled=1 bin/phpunit --coverage-text --colors=never --testsuite='unit' --coverage-cobertura coverage.xml --log-junit report-unit.xml
    # pcov.enabled is necessary for coverage calculation to be possible
    # --coverage-text is used to have a detailed view in the job's log
    # --coverage-cobertura generates the coverage report to be displayed in the MR
    # --log-junit generates the test report for display in the pipeline
    - sed -i "s_${CI_PROJECT_DIR}__g" report-unit.xml   # use relative path instead of absolute path in test report
  artifacts:
    reports:
      cobertura: coverage.xml
      junit: report-unit.xml

# Deployment

ðŸš€ prod:
  stage: ðŸš€ deploy
  extends: .deploy-api
  environment:
    name: prod
    url: https://api.kls-platform.com
  tags:
    - prod-deployment
  only:
    refs:
      - /^[1-9][0-9]*\.[0-9]+\.[0-9]+$/

ðŸš€ preprod:
  stage: ðŸš€ deploy
  extends: .deploy-api
  environment:
    name: preprod
    url: https://api.preprod.kls-platform.com
  only:
    refs:
      - /^release/.*/
      - /^hotfix/.*/
      - /^[1-9][0-9]*\.[0-9]+\.[0-9]+$/

e2e:preprod:
  stage: ðŸ’» e2e
  trigger:
    # relative path and variables don't work here
    project: ca-lending-services/e2e
    strategy: depend
  variables:
    CYPRESS_environment: preprod
  needs:
    - ðŸš€ preprod
  only:
    refs:
      - /^release/.*/
      - /^hotfix/.*/
      - /^[1-9][0-9]*\.[0-9]+\.[0-9]+$/

ðŸš€ demo:
  stage: ðŸš€ deploy
  extends: .deploy-api
  environment:
    name: demo
    url: https://api.demo.kls-platform.com

ðŸš€ integration:
  stage: ðŸš€ deploy
  extends: .deploy-api
  environment:
    name: integration
    url: https://api.integration.kls-platform.com
  when: on_success
  only:
    refs:
      - develop

ðŸš€ cg:
  stage: ðŸš€ deploy
  extends: .deploy-api
  environment:
    name: cg
    url: https://api.cg.kls-platform.com

ðŸš€ sandbox:
  stage: ðŸš€ deploy
  extends: .deploy-api
  environment:
    name: sandbox
    url: https://api.sandbox.kls-platform.com
