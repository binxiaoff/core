imports:
    - { resource: parameters.yml }
    - { resource: security.yml }
    - { resource: parameters_extended.yml, ignore_errors: true }
    - { resource: dql_mysql_functions.yml }
    - { resource: services.yaml }
    - { resource: services_legacy/messaging.yaml}

framework:
    secret: "%secret%"
    router:
        resource: "%kernel.root_dir%/config/routing.yml"
        strict_requirements: ~
    default_locale:  "%locale%"
    templating:
        engines: ['twig']
    assets:
        base_urls:
            - "%router.request_context.scheme%://%url.host_default%"
        packages:
            gulp:
                base_path: /assets
        json_manifest_path: '%kernel.root_dir%/../public/default/assets/rev-manifest.json'
    translator:
        fallbacks: ["%locale%"]
    session:
        handler_id: null
        gc_maxlifetime: 3600
    csrf_protection: true
    form:
        csrf_protection:
            field_name: _csrf
    serializer:
        enabled: true
    validation:
        enabled: true

sensio_framework_extra:
    router:
        # Enabling the “sensio_framework_extra.router.annotations” configuration is deprecated
        # It was enabled by default. And there’s a pull request to make it disabled by default.
        annotations: false

cmf_routing:
    chain:
        routers_by_id:
            router.default: 200
            cmf_routing.dynamic_router: 100
    dynamic:
        enabled: true
        default_controller: Unilend\Bundle\FrontBundle\Controller\MainController::cmsAction
        route_provider_service_id: Unilend\Bundle\FrontBundle\Service\RouteProvider

twig:
    strict_variables: "%kernel.debug%"
    paths:
        - "%kernel.root_dir%/Resources/views/frontbundle/"
    form_themes:
        - 'frontbundle/layouts/form_layout.html.twig'

doctrine:
    dbal:
        default_connection: default
        connections:
            default:
                driver:        "%database_driver%"
                host:          "%database_host%"
                port:          "%database_port%"
                dbname:        "%database_name%"
                user:          "%database_user%"
                password:      "%database_password%"
                charset:       utf8mb4
                wrapper_class: "%dbal_wrapper_class%"
                driver_class:  "%dbal_driver_class%"
                default_table_options:
                    charset: utf8mb4
                    collate: utf8mb4_unicode_ci
                mapping_types:
                    enum: string
                options:
                    x_reconnect_attempts: 3
                schema_filter: ~^(?!(project_search|xerfi))~
            # connection dedicated to Doctrine Migration bundle
            migration:
                driver:        "%database_driver%"
                host:          "%database_host%"
                port:          "%database_port%"
                dbname:        "%database_name%"
                user:          "%database_user_migration%"
                password:      "%database_password_migration%"
                charset:       utf8mb4
                wrapper_class: "%dbal_wrapper_class%"
                driver_class:  "%dbal_driver_class%"
                default_table_options:
                    charset: utf8mb4
                    collate: utf8mb4_unicode_ci
                mapping_types:
                    enum: string
                options:
                    x_reconnect_attempts: 3
                schema_filter: ~^(?!(project_search|xerfi))~
    orm:
        auto_generate_proxy_classes: "%kernel.debug%"
        entity_managers:
            default:
                naming_strategy: doctrine.orm.naming_strategy.underscore
                mappings:
                    custom_mapping:
                        type: annotation
                        prefix: Unilend\Entity\
                        dir: "%kernel.project_dir%/src/Entity/"
                        is_bundle: false


doctrine_migrations:
    name: Database Migrations
    dir_name: '%kernel.project_dir%/src/Migrations'
    namespace: DoctrineMigrations
    organize_migrations: BY_YEAR
    column_length: 30

doctrine_mongodb:
    connections:
        default:
            server: "%mongodb_server%"
            options:
                authMechanism:  SCRAM-SHA-1
                authSource:     "%mongodb_auth_source%"
                connect:        true
                ssl:            "%mongodb_ssl_connect%"
                password:       "%mongodb_password%"
                username:       "%mongodb_username%"
                readPreference: primaryPreferred
                replicaSet:     "%mongodb_replica_set_name%"
    default_database: "%mongodb_default_database%"
    document_managers:
        default:
            auto_mapping: true
            retry_connect: 4
            retry_query:   4

cache_adapter:
    providers:
        default_memcache_adapter:
            factory: 'cache.factory.memcache'
            options:
                host: "%server1.memcache_host%"
                port: "%server1.memcache_port%"
            aliases: ['memcache.default']

monolog:
    channels: [console, mongodb, wsclient]
    handlers:
        error:
            type: fingers_crossed
            action_level: error
            handler: error_handler
            channels: ['!translation']
        error_handler:
            type: group
            members: [error_file]
#           members: [file_error, slack_error]
        error_file:
            type: rotating_file
            level: info
            path: "%kernel.logs_dir%/error.%kernel.environment%.log"
            max_files: 90
            date_format: 'Y-m-d'
            file_permission: 0664
#        slack_error:
#            type: slack
#            level: error
#            token: xoxb-54621264262-6EXEn7g59rpWe7vDxzHht5z5
#            channel: '#it-releases'
#            bot_name: 'Symfony Bot'

        console_filter:
            type: filter
            handler: console_handler
            max_level: warning
            channels: console
        console_handler:
            type: group
            members: [console_file, console_console]
        console_file:
            type: rotating_file
            path: "%kernel.logs_dir%/console.%kernel.environment%.log"
            level: info
            max_files: 90
            file_permission: 0664
            date_format: 'Y-m-d'
        console_console:
            type: console

        site_filter:
            type: filter
            handler: site_handler
            max_level: warning
            channels: ['!console', '!translation', '!mongodb', '!wsclient']
        site_handler:
            type: rotating_file
            level: warning
            path: "%kernel.logs_dir%/site.%kernel.environment%.log"
            max_files: 90
            file_permission: 0664
            date_format: 'Y-m-d'

        mongodb:
            type: fingers_crossed
            action_level: warning
            handler: mongodb_handler
            channels: mongodb
        mongodb_handler:
            type: rotating_file
            level: debug
            path: "%kernel.logs_dir%/mongodb.%kernel.environment%.log"
            max_files: 90
            file_permission: 0664
            date_format: 'Y-m-d'

        wsclient:
            type: fingers_crossed
            action_level: warning
            handler: wsclient_handler
            channels: wsclient
        wsclient_handler:
            type: rotating_file
            level: debug
            path: "%kernel.logs_dir%/wsclient.%kernel.environment%.log"
            max_files: 90
            file_permission: 0664
            date_format: 'Y-m-d'

swiftmailer:
    transport: '%mailer_transport%'
    host: '%mailer_host%'
    port: '%mailer_port%'

google_tag_manager:
    enabled: false
    id: "%google.gtm_token%"
    autoAppend: false

#sonata_seo:
#    encoding: UTF-8
#    page:
#        title: 'Unilend : les particuliers prêtent aux entreprises françaises'
#        default: sonata.seo.page.default
#        metas:
#            name:
#                keywords: 'Prêter Emprunter'
#                description: 'Sur Unilend, tout le monde peut prêter aux entreprises françaises et recevoir des intérêts.'
#                robots: 'index, follow'
#                viewport: 'width=device-width, initial-scale=1'
#
#            http-equiv:
#                'Content-Type': 'text/html; charset=utf-8'
#                'X-UA-Compatible': 'IE=edge,chrome=1;'

knp_snappy:
    pdf:
        enabled: true
        binary: /usr/local/bin/wkhtmltopdf
        options:
            - { name: 'page-size', value: 'A4' }
            - { name: 'encoding', value: 'UTF-8'}

ekino_new_relic:
    enabled: false
#    application_name: "%new_relic.front_app_name%"
#    api_key: "%new_relic.api_key%"
#    instrument: true
#    deprecations: false
#    http:
#        using_symfony_cache: true
#    monolog:
#        enabled: true
#        channels: ~

sonata_cache:
    caches:
        symfony:
            token: ddb80e7065db6ecee2f3768704d
            php_cache_enabled: true
            types: [translations]
            servers: "%sonata_cache.servers%"

eight_points_guzzle:
    clients:
        euler:
            base_url: "%euler.url%"
            options:
                timeout: 16
                http_errors: false
        codinf:
            base_url: "%codinf.url%"
            options:
                http_errors: false

        infolegale:
            base_url: "%infolegale.url%"
            options:
                http_errors: false
        ellisphere:
            base_url: "%ellisphere.url%"
            options:
                http_errors: false
        google_recaptcha:
            base_url: "%google.recaptcha_url%"
            options:
                http_errors: false
        greenpoint:
            base_url: "%greenpoint.url%"
            options:
                headers:
                    Accept: "application/json"
                http_errors: false
        insee:
            base_url: "https://api.insee.fr/entreprises/sirene/V3/siren/"
            options:
                headers:
                    Accept: "application/json"
                    Authorization: "Bearer 6a92714f-2b81-313c-be11-d90039c2a53b"
                http_errors: false

welp_mailchimp:
    api_key: "%mailchimp.api_key%"
    list_provider: welp_mailchimp.list_provider
    lists:
        "%mailchimp.list_id%":
            subscriber_provider: 'Unilend\Bundle\CoreBusinessBundle\Event\MailChimpEventSubscriber'
            webhook_secret: "%mailchimp.webhook_secret%"
            webhook_url: "%router.request_context.scheme%://%url.host_default%"
            merge_fields:
                -
                    tag: FNAME
                    name: Prénom
                    type: text
                    public: true
                -
                    tag: LNAME
                    name: Nom
                    type: text
                    public: true

httplug:
    plugins:
        logger: ~
    clients:
        nexy_slack:
            factory: 'httplug.factory.guzzle6'
            plugins: ['httplug.plugin.logger']
            config:
                timeout: 2

nexy_slack:
    http:
        client: httplug.client.nexy_slack
    endpoint: '%slack.endpoint%'
    channel: '%slack.default_channel%'
    username: '%slack.default_username%'
