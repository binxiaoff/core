{% set loansChartData = {
    charts: {
        lenderOperations: {
            type: 'preterOperations',
            background: 'none',
            highcharts: {
                chart: {
                    type: 'pie',
                    width: 300,
                    height: 300,
                    marginTop: 0,
                    marginBottom: 0,
                    marginLeft: 0,
                    marginRight: 10,
                    spacingTop: 0,
                    spacingBottom: 0,
                    spacingLeft: 0,
                    spacingRight: 0
                },
                title: {
                    text: ''
                },
                legend: {
                    enabled: false,
                    layout: 'vertical',
                    symbolRadius: 10,
                    align: 'right',
                    verticalAlign: 'middle'
                },
                tooltip: {
                    pointFormat: ' '
                },
                plotOptions: {
                    pie: {
                        innerSize: '50%',
                        showInLegend: true,
                        dataLabels: {
                            enabled: false
                        }
                    }
                },
                series: [{
                    data: seriesData
                }],
            }
        }
    }
    }
%}

<div class="panel panel-operations-loans">
    <header class="panel-header">
        <h3 class="panel-title">{% transchoice lenderLoans|length with { '%count%' : lenderLoans|length } %} lender-operations_loans-table-title {% endtranschoice %}</h3>
        {% if lenderLoans|length > 0 %}
        <div class="panel-controls">
            <a href="/pdf/loans/{{ hash }}" class="btn-default">
                <span class="icon fa-print-u32"></span>
                <span class="label"> {% trans %} lender-operations_print {% endtrans %} </span>
            </a>
            <a href="{{ path('export_loans_csv') }}" class="btn-default">
                <span class="icon fa-excel-u32"></span>
                <span class="label"> {% trans %} lender-operations_csv-export-button {% endtrans %} </span>
            </a>
        </div><!-- /.panel-controls -->
        {% endif %}
    </header><!-- /.panel-header -->

    <div class="panel-content">
        <div class="panel-before-table">
            {% if lenderLoans|length > 0 %}
            <div class="chart" data-chartview='{{ loansChartData.charts.lenderOperations|json_encode|escape('html_attr') }}'></div>

            {# Responsive issues, so I am rendering the legend in the page itself, rather than in the chart above #}
            <div class="chart-legend">
                {% for i, series in loansChartData.charts.lenderOperations.highcharts.series %}
                    {% for j, dataItem in series.data if dataItem.showInLegend is defined %}
                        <div class="chart-key">
                            <div class="icon" style="background-color: {{ dataItem.color }}"></div>
                            <div class="label">{{ dataItem.name }}</div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <form id="form-filters-loans" action="{{ path('filter_loans') }}" method="post" class="form-filters" data-ajax>
                <input class="id_last_action" type="hidden" name="filter[id_last_action]" value="">
                <div class="row row-multi-col">
                    <div class="form-field col-lg-6 col-md-6 col-sm-4 col-xs-2">
                        <select id="filter-status" name="filter[status]" class="input-field">
                            <option value="">{% trans %} lender-operations_loans-table-by-status-filter {% endtrans %}</option>
                            {% for statusDetail in loansStatusFilter %}
                                <option value="{{ statusDetail.status }}" {% if currentFilters is not empty and currentFilters.filter.status == statusDetail.status %} selected="selected" {% endif %}>{{ "lender-operations_project-status-label-#{ statusDetail.status }" | trans }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-field col-lg-6 col-md-6 col-sm-4 col-xs-2">
                        <select id="filter-next" name="filter[date]" class="input-field">
                            <option value=""> {% trans %} lender-operations_loans-table-by-date-filter {% endtrans %} </option>
                            {% for year in firstLoanYear..date()|date('Y') %}
                                <option value="{{ year }}" {% if currentFilters is not empty and currentFilters.filter.date == year %} selected="selected" {% endif %}> {{ year }} </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form><!-- /.form-filters -->
        </div><!-- /.panel-before-table -->

        {% if lenderLoans|length > 0 %}
        <div class="table-scroll">
            <table class="table table-myloans" data-sortable>
                <thead>
                <tr>
                    <th class="table-sortable-column table-myloans-item-project" data-sortable-by="project">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-project-name-column'|trans }} </span> {% trans %} lender-operations_loans-table-project-column {% endtrans %} </span>
                    </th>
                    <th class="table-sortable-column table-myloans-item-rating" data-sortable-by="rating">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-project-rate-column'|trans }} </span>{% trans %} lender-operations_loans-table-project-risk-column {% endtrans %}</span>
                    </th>
                    <th class="table-sortable-column table-myloans-item-amount" data-sortable-by="amount">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-loan-amount-column'|trans }} </span>{% trans %} lender-operations_loans-table-amount-column {% endtrans %}</span>
                    </th>
                    <th class="table-sortable-column table-myloans-item-interest" data-sortable-by="interest">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-loan-rate-column'|trans }} </span>{% trans %} lender-operations_loans-table-loan-rate-column {% endtrans %}</span>
                    </th>
                    <th class="table-sortable-column table-myloans-item-monthly" data-sortable-by="monthly">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-monthly-installment-column'|trans }} </span> {% trans %} lender-operations_loans-table-monthly-installment-amount-column {% endtrans %} </span>
                    </th>
                    <th class="table-sortable-column table-myloans-item-next" data-sortable-by="next">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-next-monthly-installment-column'|trans }} </span>{% trans %} lender-operations_loans-table-next-monthly-installment-date-column {% endtrans %}</span>
                    </th>
                    <th class="table-sortable-column table-myloans-item-duration" data-sortable-by="duration">
                        <span class="label"><span class="sr-only">{{ 'lender-operations_sr-sort-loan-remaining-monthly-installments-column'|trans }} </span>{% trans %} lender-operations_loans-table-remaining-monthly-installments-column {% endtrans %}</span>
                    </th>
                    <th class="table-myloans-item-documents">
                        <span class="label">{% trans %} lender-operations_loans-table-documents-column {% endtrans %}</span>
                    </th>
                </tr>
                </thead>
                <tbody data-sortable-content>
                {% for i, loan in lenderLoans %}

                    {#{{ dump(loan) }}#}

                    {# @TODO Remove below when new loan structure has been implemented into PHP controller #}
                    {# New loan structure `loan` var should be injected into `data-details` as JSON object #}

                    {# Process loan document details due to fragmented loan model #}
                    {% set loans = [] %}
                    {% set countBonds = 0 %}
                    {% set countContracts = 0 %}

                    {# Single loan has documents property... #}
                    {% if loan.documents is defined %}
                        {% set newDocs = [] %}
                        {% for x, doc in loan.documents %}
                            {% set newDoc = {
                                url: doc.url,
                                type: doc.docType,
                                label: doc.docTypeName
                            } %}
                            {% if newDoc.type == 'bond' %}
                                {% set countBonds = countBonds + 1 %}
                            {% elseif newDoc.type == 'contract' %}
                                {% set countContracts = countContracts + 1 %}
                            {% endif %}
                            {% set newDocs = newDocs|merge([newDoc]) %}
                        {% endfor %}
                        {% set loans = loans|merge([{
                            rate: loan.rate,
                            amount: loan.amount,
                            documents: newDocs
                        }]) %}
                    {% endif %}

                    {# Multiple loans has loan_details property with nested documents property #}
                    {% if loan.loan_details is defined %}
                        {% for w, loanDetails in loan.loan_details if loanDetails.documents is defined %}
                            {% set newDocs = [] %}
                            {% for x, doc in loanDetails.documents %}
                                {% set newDoc = {
                                    url: doc.url,
                                    type: doc.docType,
                                    label: doc.docTypeName
                                } %}
                                {% if newDoc.type == 'bond' %}
                                    {% set countBonds = countBonds + 1 %}
                                {% elseif newDoc.type == 'contract' %}
                                    {% set countContracts = countContracts + 1 %}
                                {% endif %}
                                {% set newDocs = newDocs|merge([newDoc]) %}
                            {% endfor %}
                            {% set loans = loans|merge([{
                                rate: loanDetails.rate,
                                amount: loanDetails.amount,
                                documents: newDocs
                            }]) %}
                        {% endfor %}
                    {% endif %}

                    {# Set the loan details as JSON for rendering client-side when details are visible #}
                    {% set loan = {
                        id: loan.id_project,
                        url: path('project_detail', {'projectSlug' : loan.slug}),
                        name: loan.title,
                        rate: loan.rate,
                        risk: loan.risk|convertRisk,
                        amount: loan.amount,
                        start_date: loan.debut,
                        end_date: loan.fin,
                        next_payment_date: loan.next_echeance,
                        monthly: loan.mensuel,
                        duration: loan.project_duration,
                        status: loan.status_color,
                        loans: loans,
                        count: {
                            bond: countBonds,
                            contract: countContracts,
                            declaration: 0
                        }
                    } %}

                    <tr id="loan-{{ loan.id }}" class="table-myloans-item {{ 'ui-loan-status-' ~ loan.status }}"
                        data-sortable-status="{{ loan.status }}"
                        data-sortable-project="{{ loan.name|escape('html_attr') }}"
                        data-sortable-rating="{{ loan.risk }}"
                        data-sortable-amount="{{ loan.amount }}"
                        data-sortable-interest="{{ loan.rate }}"
                        data-sortable-monthly="{{ loan.monthly }}"
                        data-sortable-next="{{ loan.next_payment_date|date('U') }}"
                        data-sortable-duration="{{ loan.duration }}"
                            {% if loan.loans|length > 1 %} data-details='{{ loan|json_encode|escape('html_attr') }}' {% endif %}>
                        <td class="table-myloans-item-project">
                            <a href="{{ loan.url }}" target="_blank">{{ loan.name }}</a>
                        </td>
                        <td class="table-myloans-item-rating">
                            <span class="rating rating-{{ loan.risk|split('.')|join('-') }}"><span class="sr-only">Rated {{ loan.risk }} out of 5</span></span>
                        </td>
                        <td class="table-myloans-item-amount">
                            {{ loan.amount|localizednumber }}&nbsp;€
                        </td>
                        <td class="table-myloans-item-interest">
                            {{ loan.rate|localizednumber }}&nbsp;<sup>%</sup>
                        </td>
                        <td class="table-myloans-item-monthly">
                            {% if loan.project_status == constant('\\projects_status::REMBOURSEMENT_ANTICIPE') or loan.project_status == constant('\\projects_status::REMBOURSE') %}
                                &nbsp;
                            {% else %}
                                {{ loan.mensuel|localizedcurrency('EUR') }}
                            {% endif %}
                        </td>
                        <td class="table-myloans-item-next">
                            {{ loan.next_payment_date|date('d/m/y') }}
                            {% if loan.project_status == constant('\\projects_status::REMBOURSEMENT_ANTICIPE') or loan.project_status == constant('\\projects_status::REMBOURSE') %}
                                {% trans with {'%date%': loan.debut|date('d/m/Y')} %} lender-operations_loans-table-project-status-label-repayment-finished-on-date {% endtrans %}
                            {% else %}
                                {{ loan.next_echeance|date('d/m/y') }}
                            {% endif %}
                        </td>
                        <td class="table-myloans-item-duration">
                            <span class="ui-has-tooltip" title="{{ 'lender-operations_from'|trans|capitalize }} {{ loan.start_date|date('d/m/Y') }} {{ 'lender-operations_to'|trans }} {{ loan.end_date|date('d/m/Y') }}" data-toggle="tooltip">{% trans with { '%count%' : loan.duration} %} lender-operations_month {% endtrans %}</span>
                            {% if loan.project_status == constant('\\projects_status::REMBOURSEMENT_ANTICIPE') or loan.project_status == constant('\\projects_status::REMBOURSE') %}
                                &nbsp;
                            {% else %}
                                <span class="ui-has-tooltip" title="{% trans with {'%startDate%': loan.debut|date('d/m/Y'), '%endDate%': loan.fin|date('d/m/Y')} %} lender-operations_remaining-duration-tooltip {% endtrans %}" data-toggle="tooltip">{% trans with { '%count%' : loan.project_remaining_duration} %} lender-operations_loans-table-project-remaining-month {% endtrans %}</span>
                            {% endif %}
                        </td>
                        <td class="table-myloans-item-documents">
                            {# Multiple #}
                            {% if loan.loans|length > 1 %}
                                {% for docType, totalCount in loan.count if totalCount > 0 %}
                                    <a href="javascript:;" class="loan-doc loan-doc-{{ docType }}">
                                        <span class="pip"><span class="pip-number">{{ totalCount }}</span></span>
                                    </a>
                                {% endfor %}
                            {# Single #}
                            {% else %}
                                {% for i, doc in loan.loans[0].documents %}
                                    <a href="{{ doc.url }}" title="{{ doc.label|escape('html_attr') }}" class="loan-doc loan-doc-{{ doc.type }}" data-toggle="tooltip"><span class="sr-only">{{ doc.label }}</span></a>
                                {% endfor %}
                            {% endif %}
                        </td>
                    </tr>
                    {#{% if loan.nb_loan > 1 %}
                        {% for loanDetails in loan.loan_details %}
                            <tr>
                                <td colspan="2"></td>
                                <td class="table-myloans-item-amount">
                                    {{ loanDetails.amount|localizednumber }}&nbsp;€
                                </td>
                                <td class="table-myloans-item-interest">
                                    {{ loanDetails.rate|localizednumber }}&nbsp;<sup>%</sup>
                                </td>
                                <td colspan="3">
                                </td>
                                <td class="table-myloans-item-documents">
                                    {% for k, doc in loanDetails.documents %}
                                        <a href="{{ doc.url }}" class="loan-doc loan-doc-{{ doc.docType }}"
                                           title="{{ doc.docTypeName }}"
                                           data-toggle="tooltip">
                                        </a>
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}#}
                {% endfor %}
                </tbody>
            </table><!-- /.table-myloans -->
        </div><!-- /.table-scroll -->
        {% else %}
            <div class="message-info after">{{ 'lender-operations_no-result-found-message'|trans }}</div>
        {% endif %}
    </div><!-- /.panel-content -->
</div><!-- /.panel -->
