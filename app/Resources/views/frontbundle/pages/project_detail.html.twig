{% extends 'layouts/_layout.html.twig' %}

{% set placeholderData = {
    alloffersOverview: {
        schema: [{
            name: 'id',
            type: 'int',
            label: false
        },{
            name: 'interest',
            type: 'string',
            label: 'Taux'
        },{
            name: 'amount',
            type: 'float',
            label: 'Montant total'
        },{
            name: 'offers',
            type: 'int',
            label: 'NB offres'
        },{
            name: 'myoffers',
            type: 'int',
            label: 'Offres en cours'
        },{
            name: 'accepted',
            type: 'int',
            label: false
        }],
        data: [
            [1, '4&ndash;4,5%', 850.15, 24, 0, 100],
            [2, '4.5&ndash;5%', 923.74, 32, 1, 100],
            [3, '5&ndash;5,5%', 1250.4, 64, 0, 97],
            [4, '5,5&ndash;6%', 1511.12, 102, 0, 65],
            [5, '6&ndash;6,5%', 2912.89, 159, 5, 49],
            [6, '6,6%', 3250.74, 54, 0, 28],
            [7, '6,7%', 3250.74, 64, 0, 24],
            [8, '6,8%', 3250.74, 71, 0, 19],
            [9, '6,9%', 3250.74, 82, 0, 15],
            [10, '7%', 3250.74, 97, 0, 9],
            [11, '7,1%', 3250.74, 101, 0, 2],
            [12, '7,2&ndash;7,5%', 3250.74, 101, 0, 0],
            [13, '7,5&ndash;8%', 3250.74, 224, 0, 0],
            [14, '8&ndash;8,5%', 3250.74, 314, 0, 0],
            [15, '8,5&ndash;9%', 3250.74, 396, 0, 0],
            [16, '9&ndash;9,5%', 3250.74, 520, 0, 0],
            [17, '9,5&ndash;10%', 3250.74, 850, 0, 0]
        ]
    }
} %}

{% set bodyId = '' %}
{% set page= {
    title: project.title,
    permalink: project.slug
} %}

{# View data #}
{# Set the rating class for the .rating element #}
{% set classRating = project.risk|convertRisk|split('.')|join('-') %}

{% block siteContent %}
    <article id="project-single" class="page project-single project-category-{{ project.categoryId }}">
        <header class="project-single-header-wrap">
            {# Generate object for mapview to place marker on map #}
            {% if project.latitude is defined and project.longitude is defined %}
                {# Set the group based on active, expired, or offers inprogress, rejected or accepted #}
                {# @note MapView JS component & CSS relies on two groups named 'active' and 'expired' (case insensitive) #}
                {#{% set mapviewGroup = (listItem.daysLeft == 0 ? 'expired' : 'active') %}#}
                {% set mapviewGroup = 'active' %}

                {# Set the offer status to show the icon in the marker #}
                {# @note MapView CSS relies on offerStatuses named 'inprogress', 'rejected' and 'accepted' #}
                {% set mapviewOfferStatus = '' %}

                {#{% if lenderOnProject is defined and lenderOnProject.bids.count > 0 %}#}
                    {#{% for statusOffer, numOffers in currentUserOffers if numOffers > 0 and statusOffer is not empty and statusOffer != 'rejected' %}#}
                        {#{% set mapviewOfferStatus = statusOffer %}#}
                    {#{% endfor %}#}
                {#{% endif %}#}

                {# Output map HTML #}
                <div class="project-single-map">
                    {# The MapView element #}
                    {% set mapview = {
                        target: '#project-map',
                        showFilters: false,
                        mapbox: {
                            center: [project.latitude, project.longitude],
                            zoom: 13
                        },
                        groups: ['all'],
                        markers: [{
                            id: 'marker' ~ project.id_project,
                            categoryId: project.categoryId,
                            latLng: [project.latitude, project.longitude],
                            title: project.title,
                            description: '<div style="font-style: italic;">' ~ project.company.city ~ ', ' ~ project.company.zip ~ '</div><div class="rating rating-' ~ classRating ~ '"><span class="sr-only">Rated ' ~ project.risk ~ ' out of 5</span></span></div>',
                            status: (project.daysLeft == 0 ? 'expired' : 'active'),
                            offerStatus: mapviewOfferStatus|default(''),
                            groupName: 'all'
                        }]
                    } %}

                    {# @note This MapView will only be initialised when it's first viewed, to reduce calls to Mapbox and lower API usage (see showProjectSingleMap function in main.dev.js) #}
                    <div id="project-map" class="project-single-map-embed">
                        <a href="javascript:;" class="btn-close ui-project-single-map-toggle"><span class="label sr-only">Close Map</span></a>
                    </div>
                    <script type="text/javascript">
                        var projectMapViewSettings = '{{ mapview|json_encode|escape('js') }}'
                    </script>
                </div><!-- /.project-single-map -->
            {% endif %}

            <div class="project-single-header">
                <div class="project-single-header-position">
                    <div class="project-single-header-inner">
                        <div class="project-single-category">
                            <div class="svg-icon-wrap" style="max-width: 160px">
                                <canvas class="svg-icon-aspect" width="160" height="160"></canvas>
                                {{ svgimage('#category-' ~ project.categoryId, '', 160, 160) | raw }}
                            </div>
                        </div><!-- /.project-single-category -->

                        <div class="row">
                            <div class="col-lg-8 col-md-8">
                                <div class="project-single-details">
                                    <h1 class="project-single-title">{{ project.title }}</h1>
                                    <div class="project-single-meta">
                                        <h4 class="project-single-location">
                                            <span class="icon fa-map-marker-u16"></span>
                                            <span class="label">{{ project.company.city }}, {{ project.company.zip }}</span>
                                            {% if mapview is defined %}
                                                <a href="javascript:;" class="link ui-project-single-map-toggle">
                                                    <span class="label">{% trans %} project-detail_show-map-label {% endtrans %}</span>
                                                </a>
                                            {% endif %}
                                        </h4>
                                    </div><!-- /.project-single-meta -->
                                </div><!-- /.project-single-details -->
                            </div>

                            <div class="col-lg-4 col-md-4 hide-xs">
                                <div class="project-single-rating">
                                    <div class="label">{% trans %} project-detail_unilend-rating-label {% endtrans %}</div>
                                    <span class="rating rating-{{ classRating }}">
                                        <span class="sr-only">
                                            {% trans with {'%risk%' : project.risk|convertRisk} %} project-detail_unilend-rating-wording-label {% endtrans %}
                                        </span>
                                    </span>
                                </div><!-- /.project-single-rating -->
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-10 col-md-9">
                                <div class="project-single-description">
                                    {{ project.nature_project|nl2br }}
                                </div><!-- /.project-single-description -->
                            </div>
                        </div>

                        <div class="row">
                            {% if project.photo_projet is not empty %}
                                <div class="col-lg-5 col-md-4 hide-tablet-l hide-sm hide-xs">
                                    <div class="project-single-image">
                                        <img src="{{ project.photo_projet|completeProjectImagePath }}" alt="">
                                    </div><!-- /.project-single-image -->
                                </div>
                            {% endif %}

                            <div class="col-lg-5 col-md-5 col-sm-6">
                                <div class="project-single-period">
                                    <div class="project-single-period-countdown"><span class="icon fa-clock-u32"></span>
                                        <span class="ui-has-timecount" data-timecount-to="{{ project.date_retrait_full|escape('html_attr') }}">
                                            {% transchoice project.date_retrait_full with {'%time%' : project.date_retrait_full }%} project-detail_timer-count-remaining {% endtranschoice %}
                                        </span>
                                    </div>
                                    <div class="project-single-period-expires">{% trans %} project-detail_project-end-label {% endtrans %} {{ project.date_retrait_full|date('l j F Y Ã  H:i') }}</div>
                                </div><!-- /.project-single-period -->

                                <div class="project-single-offers">
                                    {% if lenderOnProject.bids.offers is defined and lenderOnProject.bids.offers.total > 0 %}
                                    {% for status, numOffers in lenderOnProject.bids.offers %}
                                        {% if status == 'inprogress' and numOffers > 0 %}
                                            <div class="project-list-item-useroffers-accepted">
                                                {{ numOffers|__num(0)|nbsp }} {% transchoice numOffers %} project-detail_accepted-bids-label {% endtranschoice %}
                                            </div>
                                        {% elseif status == 'rejected' and numOffers > 0 %}
                                            <div class="project-list-item-useroffers-rejected">
                                                {{ numOffers|__num(0)|nbsp }} {% transchoice numOffers %} project-detail_rejected-bids-label {% endtranschoice %}
                                            </div>
                                        {% elseif status == 'accepted' and numOffers > 0 %}
                                            <div class="project-list-item-useroffers-inprogress">
                                                {{ numOffers|__num(0)|nbsp }} {% transchoice numOffers %} project-detail_pending-bids-label {% endtranschoice %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    {% endif %}

                                    <div class="project-single-offers-total">
                                        {% trans with { '%totalLenders%' : '<strong>' ~ project.totalLenders|__num(0)|nbsp ~ '</strong>' }%} project-detail_offres-total-label {% endtrans %}
                                    </div>
                                </div><!-- /.project-single-offers -->

                                {# Responsive cheat #}
                                <div class="show-xs">
                                    <div class="project-single-rating">
                                        <div class="label">{% trans %} project-detail_unilend-rating-label {% endtrans %}</div>
                                        <span class="rating rating-{{ classRating }}"><span class="sr-only">
                                                {% trans with {'%risk%' : project.risk|convertRisk }%} project-detail_unilend-rating-wording-label {% endtrans %}</span></span>
                                    </div><!-- /.project-single-rating -->
                                </div><!-- /.show-xs -->
                            </div>
                        </div>
                    </div><!-- /.project-single-header-inner -->
                </div><!-- /.project-single-header-position -->
                {% if project.navigation.previousProject is defined and project.navigation.previousProject is not empty %}
                <a href="{{ path('project_detail', {'projectSlug' : project.navigation.previousProject.slug}) }}" class="btn-nav-previous" title="{{ project.navigation.previousProject.title }}" data-toggle="tooltip" data-placement="right"><span class="sr-only">{% trans %} project-detail_next-project-label {% endtrans %}</span></a>
                {%  endif %}
                {% if project.navigation.nextProject is defined %}
                <a href="{{ path('project_detail', {'projectSlug' : project.navigation.nextProject.slug}) }}" class="btn-nav-next" title="{{ project.navigation.nextProject.title }}" data-toggle="tooltip" data-placement="left"><span class="sr-only">{% trans %} project-detail_previous-project-label {% endtrans %}</span></a>
                {%  endif %}
            </div><!-- /.project-single-header -->

            {% include 'partials/components/list-socialmedia.html.twig' %}
        </header><!-- /.project-single-header-wrap -->

        {% include 'partials/components/project-detail/side-panel.html.twig' %}

        <div class="project-single-menu">
            <div class="project-single-menu-inner">
                <nav class="project-single-nav">
                    <ul class="nav nav-anchors">
                        {% if conditions.bids %}
                            <li role="presentation"><a href="#offers">{% trans %} project-detail_presentation-title-offers {% endtrans %}</a></li>
                        {% endif %}
                        <li role="presentation"><a href="#presentation">{% trans %} project-detail_presentation-title-presentation {% endtrans %}</a></li>
                        <li role="presentation"><a href="#finance">{% trans %} project-detail_presentation-title-financial-accounts {% endtrans %}</a></li>
                        {% if conditions.history %}
                            <li role="presentation"><a href="#history">{% trans %} project-detail_presentation-title-repayment-info {% endtrans %}</a></li>
                        {% endif %}
                    </ul>
                </nav><!-- /.project-single-nav -->

                <div class="project-single-menu-info">
                    <div class="project-single-menu-col project-single-menu-title">
                        <div class="title">{{ project.title }}</div>
                        <span class="rating rating-{{ classRating }}"><span class="sr-only">{% trans with {'%risk%' : project.risk|convertRisk }%} project-detail_unilend-rating-wording-label {% endtrans %}</span></span>
                    </div><!-- /.project-single-menu-title -->
                    <div class="project-single-menu-col project-single-menu-period">
                        <span class="icon fa-clock-u32"></span>
                        <span class="ui-has-timecount" data-timecount-to="{{ project.date_retrait_full|escape('html_attr') }}">&hellip;</span>
                    </div><!-- /.project-single-menu-period -->
                    <div class="project-single-menu-col project-single-menu-top">
                        <a href="#top" class="btn-nav-top"><span class="sr-only">Back to top</span></a>
                    </div><!-- /.project-single-menu-top -->
                </div><!-- /.project-single-menu-info -->
            </div><!-- /.project-single-nav-inner -->
        </div><!-- /.project-single-menu -->

        <div class="project-single-content page-content">
            <div class="site-wrap">
                <div class="row">
                    <div class="col-lg-8 col-md-8">
                        <nav class="project-single-nav">
                            <ul class="nav nav-anchors">
                                {% if conditions.bids %}
                                    <li role="presentation"><a href="#offers">{% trans %} project-detail_presentation-title-offers {% endtrans %}</a></li>
                                {% endif %}
                                <li role="presentation"><a href="#presentation">{% trans %} project-detail_presentation-title-presentation {% endtrans %}</a></li>
                                <li role="presentation"><a href="#finance">{% trans %} project-detail_presentation-title-financial-accounts {% endtrans %}</a></li>
                                {% if conditions.history %}
                                    <li role="presentation"><a href="#history">{% trans %} project-detail_presentation-title-repayment-info {% endtrans %}</a></li>
                                {% endif %}
                            </ul>
                        </nav><!-- /.project-single-nav -->

                        {% if conditions.bids %}
                            <div id="offers" data-watchscroll-nav>
                                {% if conditions.myBids %}
                                    {{ include('partials/components/project-detail/my-bids.html.twig') }}
                                {% endif %}

                                {{ include('partials/components/project-detail/bids-list.html.twig') }}
                            </div>
                        {% endif %}

                        <div id="presentation" data-watchscroll-nav>
                            <section id="project-section-who" class="page-section">
                                <h3 class="h3">{% trans %} project-detail_project-presentation-about-us-title {% endtrans %}</h3>
                                <p>{{ project.presentation_company|striptags }}</p>
                            </section><!-- /.page-section -->

                            <section id="project-section-what" class="page-section">
                                <h3 class="h3">{% trans %} project-detail_project-presentation-our-project {% endtrans %}</h3>
                                <p>{{ project.objectif_loan|striptags}}</p>
                            </section><!-- /.page-section -->
                        </div>

                        {{ include('partials/components/project-detail/finance.html.twig') }}

                        <section id="project-section-help" class="page-section">
                            <h3 class="h3">{% trans %} project-detail_project-presentation-repayment-reason-title {% endtrans %}</h3>
                            <p>{{ project.means_repayment|striptags }}</p>

                            <div class="message-alert">
                                <p>{% trans %} project-detail_non-payment-warning {% endtrans %}</p>
                                <a href="{{ route('preter_guide') }}" class="link">{% trans %} project-detail_learn-more-link-under-warnings {% endtrans %}</a>
                            </div>

                            <div class="message-alert">
                                <p>{% trans %} project-detail_fiscal-information {% endtrans %}</p>
                                <a href="{{ route('fiscalite') }}" class="link">{% trans %} project-detail_learn-more-link-under-warnings {% endtrans %}</a>
                            </div>
                        </section><!-- /.page-section -->

                        {% if conditions.history %}
                            <div id="history" data-watchscroll-nav>
                                <section id="project-section-info" class="page-section">
                                    <p>{% trans with {'%amountUserLoan%' : lenderOnProject.loans.myLoanOnProject.solde} %} project-detail_project-presentation-repayment-info {% endtrans %}</p>
                                    <p>
                                        {% trans with {
                                            '%amountAlreadyPaidBack%' : lenderOnProject.loans.amountAlreadyPaidBack,
                                            '%remainingToBeRepaid%' : lenderOnProject.loans.remainingToBeRepaid,
                                            '%remainingMonths%' : lenderOnProject.loans.remainingMonths
                                        } %}
                                        project-detail_project-presentation-repayment-info-detail {% endtrans %}
                                    </p>

                                    {% if lenderOnProject.loans.amountAlreadyPaidBack > 0 %}
                                        {% for history in project.statusHistory %}
                                            {% if 'project-presentation-repayment-info-project-status-#{history.status}'|trans != 'project-presentation-repayment-info-project-status-#{history.status}' %}
                                                <p>
                                                {{ history.added|date(d/m/Y) }}
                                                    {{ 'project-presentation-repayment-info-project-status-#{history.status}'|trans }}
                                                    <br/>
                                                    {% if history.site_content is not empty %}
                                                        {{ history.content|nl2br }}
                                                        {% if history.failure == 1 %}
                                                            {% trans with {'%percentageRecovered%' : lenderOnProject.loans.percentageRecovered } %} project-detail_project-presentation-repayment-info-recovery {% endtrans %}
                                                        {% endif %}
                                                    {% endif %}
                                                </p>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </section><!-- /.page-section -->
                            </div>
                        {% endif %}
                        <div class="project-single-info-position-end"></div>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.site-wrap -->
        </div><!-- /.project-single-content -->
    </article>
    {% include 'partials/components/popup-bid-confirmation.html.twig' %}
{% endblock %}
