var $collectionHolder;
// setup an "add a fee" link
var $addFeeButton = $(`[data-action='ui-form-lending-fee-add']`);
var $newLink = $('<div class="row row-multi-col-computer"></div>').append($addFeeButton);

jQuery(document).ready(function () {
    $collectionHolder = $('div.fees');

    $collectionHolder.find('div').each(function () {
        addTagFormDeleteLink($(this));
    });

    $collectionHolder.append($newLink);

    $collectionHolder.data('index', $collectionHolder.find(':input').length);

    $addFeeButton.on('click', function () {
        addFeeForm($collectionHolder, $newLink);
    });
});

function addFeeForm($collectionHolder, $newLink) {
    var prototype = $collectionHolder.data('prototype');

    var index = $collectionHolder.data('index');

    var newForm = prototype;

    newForm = newForm.replace(/__name__/g, index);

    $collectionHolder.data('index', index + 1);

    var $newFormDiv = $('<div class="row row-multi-col-computer"></div>').append(newForm);
    $newLink.before($newFormDiv);

    var $removeFormButton = $newFormDiv.find(`[data-action='ui-form-lending-fee-remove']`);

    $removeFormButton.on('click', function () {
        $newFormDiv.remove();
    });

    var $feeTypeSelector =  $newFormDiv.find(`[data-field="ui-form-fee-type"]`);

    $feeTypeSelector.on('change', function () {
        var selectedType = $(this).children("option:selected").val();
        if (selectedType === '2') {
            $newFormDiv.find('input[type=checkbox]').prop("checked", true);
        } else {
            $newFormDiv.find('input[type=checkbox]').prop("checked", false);
        }
    });

    var $feeRateInput = $newFormDiv.find("input[id$='_percentFee_rate']");

    $feeRateInput.on('focusout', function() {
        $(this).parent().find('p.rate-amount').remove();
        if (false === $newFormDiv.find('input[type=checkbox]').prop( "checked") && $feeRateInput.val()) {
            var referenceAmount = $(`[data-fee-reference-amount]`).val()
            var rate = $feeRateInput.val().replace(',','.')
            var rateAmount = rate * referenceAmount / 100
            if (rateAmount > 0 ) {
                $feeRateInput.after('<p class="help-text rate-amount">soit ' + rateAmount.toFixed(2).replace('.',',') + ' â‚¬</p>');
            }
        }
    })
}
