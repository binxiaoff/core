{% extends 'borrower_account/_layout.html.twig' %}

{% set page = {
    id: 'user-borrower-projects',
    classNames: 'user-emprunteur-projects'
} %}

{% block dashboardContent %}
    <div class="dashboard-tabs tabs">
        <div class="dashboard-tabs-nav">
            <ul class="nav nav-dashboard-tabs nav-equal-tabs">
                <li role="presentation" class="active"><a href="#">{{ 'borrower-projects_projects-tab-title'|trans }}</a></li>
                <li role="presentation"><a href="{{ path('borrower_account_new_demand') }}">{{ 'borrower-demand_new-demand-tab-title'|trans }}</a></li>
            </ul>
        </div><!-- /.dashboard-nav-content -->

        <div class="dashboard-tabs-content tab-content">
            <div id="profile-projects" class="dashboard-tab-pane">
                <article class="panel">
                    <section role="tablist" class="ui-toggle-group" aria-multiselectable="true">
                        <div class="table-scroll">
                            {% if pre_funding_projects is not empty %}
                                <table class="table table-borrower-prefunding">
                                    <thead>
                                        <tr>
                                            <th class="table-borrower-file">
                                                <span class="label">{% trans %} borrower-projects_project-id {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-nature">
                                                <span class="label">{% trans %} borrower-projects_object {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-amount">
                                                <span class="label">{% trans %} borrower-projects_amount-and-duration {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-status">
                                                <span class="label">{% trans %} borrower-projects_status {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-autolend">
                                                <span class="label">{% trans %} borrower-projects_autolend-predict-by-precentage {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-upload">
                                                <span class="label"></span>
                                            </th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                        {% for project in pre_funding_projects %}
                                            {% if project.getStatus() in [constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::COMPLETE_REQUEST'), constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::COMMERCIAL_REVIEW')] %}
                                                {% set project_status_label = 'waiting-for-documents' %}
                                            {% elseif project.getStatus() in [constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::ANALYSIS_REVIEW'), constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::COMITY_REVIEW')] %}
                                                {% set project_status_label = 'analyzing' %}
                                            {% elseif project.getStatus() in [constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::COMMERCIAL_REJECTION'), constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::ANALYSIS_REJECTION'), constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\ProjectsStatus::COMITY_REJECTION')] %}
                                                {% set project_status_label = 'refused' %}
                                            {% else %}
                                                {# PREP_FUNDING and A_FUNDER #}
                                                {% set project_status_label = 'waiting-for-being-on-line' %}
                                            {% endif %}
                                            {% set predictAutoBid = projectPredictedAutoBidPercentage(project) %}
                                            <tr>
                                                <td>{{ project.getIdProject() }}</td>
                                                <td>{{ project.getNatureProject() }}</td>
                                                <td>{{ project.getAmount()|localizednumber }}&nbsp;€<br>{% transchoice project.getPeriod() with {'%count%' : project.getPeriod()} %} common_month {% endtranschoice %}</td>
                                                <td>{{ ('borrower-projects_' ~ project_status_label)|trans }}</td>
                                                <td>{% if predictAutoBid > 0 %} {{ predictAutoBid|localizednumber }}&nbsp;% {% endif %}</td>
                                                <td class="center">
                                                    {% if project.getHash() %}
                                                        <a href="{{ path('project_request_files', {'hash' : project.getHash()}) }}" class="ui-has-tooltip" data-original-title="{% trans %} borrower-projects_add-documents-icon {% endtrans %}"><span class="icon fa-file-u16"></span></a>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>

                        <div class="table-scroll">
                            {% if funding_projects is not empty %}
                                <table class="table table-borrower-funding">
                                    <thead>
                                        <tr>
                                            <th class="table-borrower-file">
                                                <span class="label">{% trans %} borrower-projects_project-id {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-nature">
                                                <span class="label">{% trans %} borrower-projects_object {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-amount">
                                                <span class="label">{% trans %} borrower-projects_amount-and-duration {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-ending-date">
                                                <span class="label">{% trans %} borrower-projects_end-date {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-funding-rate">
                                                <span class="label">{% trans %} borrower-projects_funding-reached-by-precentage {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-average-rate">
                                                <span class="label">{% trans %} borrower-projects_current-average-rate {% endtrans %}</span>
                                            </th>
                                            <th class="table-borrower-buttons">
                                                <span class="label"></span>
                                            </th>
                                            <th class="table-borrower-buttons">
                                                <span class="label"></span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for project in funding_projects %}
                                            {% set fundingProgress = projectFundingPercentage(project) %}
                                            {% set averageInterestRate = projectAverageInterestRate(project) %}
                                            <tr>
                                                <td>{{ project.getIdProject() }}</td>
                                                <td>{{ project.getNatureProject() }}</td>
                                                <td>{{ project.getAmount()|localizednumber }}&nbsp;€<br>{% transchoice project.getPeriod() with {'%count%' : project.getPeriod()} %} common_month {% endtranschoice %}</td>
                                                <td>{{ projectEnded(project)|localizeddate('short', 'none')}}</td>
                                                <td>{{ fundingProgress|localizednumber }}&nbsp;%</td>
                                                <td>{{ averageInterestRate|localizednumber }}&nbsp;%</td>
                                                <td>
                                                    {% if fundingProgress >= 100 and app.session.get('closingProjects')[project.getIdProject()] is not defined %}
                                                        <a href="javascript:;" class="ui-has-tooltip" data-original-title="{{ 'borrower-projects_early-closing-stop-tooltip'|trans|escape('html_attr') }}" data-modal-toggle="#close-funding-project-{{ project.getIdProject() }}">
                                                            <span class="icon fa-close-u32"></span>
                                                        </a>
                                                        <div style="display:none">
                                                            <div id="close-funding-project-{{ project.getIdProject() }}" data-modal>
                                                                <form action="{{ path('borrower_account_close_project') }}" method="post">
                                                                    <header class="modal-header">
                                                                        <h2>{{ 'borrower-projects_early-closing-lightbox-title'|trans }}</h2>
                                                                    </header>
                                                                    <div class="modal-body">
                                                                        <p>{{ 'borrower-projects_early-closing-lightbox-content'|trans({'%currentRate%' : averageInterestRate|localizednumber})|raw }}</p>
                                                                    </div>
                                                                    <footer class="modal-footer">
                                                                        <a href="javascript:;" class="btn-default" data-modal-doactionclose>{{ 'borrower-projects_early-closing-lightbox-cancel-button'|trans }}</a>
                                                                        <button type="submit" name="project" value="{{ project.getIdProject() }}" class="btn-primary">{{ 'borrower-projects_early-closing-lightbox-confirm-button'|trans }}</button>
                                                                    </footer>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    {% elseif fundingProgress >= 100  %}
                                                        <a class="ui-has-tooltip" data-original-title="{{ 'borrower-projects_early-closing-processing-tooltip'|trans|escape('html_attr') }}">
                                                            <span class="icon fa-refresh"></span>
                                                        </a>
                                                    {% endif %}
                                                </td>
                                                <td><a href="{{ path('project_detail', {'projectSlug' : project.slug }) }}" class="ui-has-tooltip" data-original-title="{{ 'borrower-projects_project-detail-link-icon'|trans|escape('html_attr') }}"><span class="icon fa-eye-u16"></span></a></td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>

                        <div class="table-scroll">
                            {% if post_funding_projects is not empty %}
                            <table class="table table-borrower-postfunding">
                                <thead>
                                    <tr>
                                        <th class="table-borrower-file">
                                            <span class="label">{% trans %} borrower-projects_project-id {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-nature">
                                            <span class="label">{% trans %} borrower-projects_object {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-amount">
                                            <span class="label">{% trans %} borrower-projects_amount-and-duration {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-ending-date">
                                            <span class="label">{% trans %} borrower-projects_end-date {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-monthly">
                                            <span class="label">{% trans %} borrower-projects_monthly-payment {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-average-rate">
                                            <span class="label">{% trans %} borrower-projects_average-rate-of-project {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-crd">
                                            <span class="label">{% trans %} borrower-projects_current-outstanding-capital {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-date">
                                            <span class="label">{% trans %} borrower-projects_next-maturity {% endtrans %}</span>
                                        </th>
                                        <th class="table-borrower-button">
                                            <span class="label"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in post_funding_projects %}
                                        <tr>
                                            <td>{{ project.getIdProject() }}</td>
                                            <td>{{ project.getNatureProject() }}</td>
                                            <td>{{ project.getAmount()|localizednumber }}&nbsp;€<br>{% transchoice project.getPeriod() with {'%count%': project.getPeriod()} %} common_month {% endtranschoice %}</td>
                                            <td>{{ projectEnded(project)|localizeddate('short', 'none')}}</td>
                                            <td>{{ projectRepaymentScheduleAmount(project)|localizedcurrency('EUR') }}</td>
                                            <td>{{ projectAverageInterestRate(project)|localizednumber }}&nbsp;%</td>
                                            <td>{{ projectRemainingCapital(project)|localizedcurrency('EUR') }}</td>
                                            <td>{{ projectNextRepaymentScheduleAmount(project)|localizeddate('short', 'none') }}</td>
                                            <td><a href="{{ path('project_detail', {'projectSlug' : project.getSlug() }) }}" class="ui-has-tooltip" data-original-title="{{ 'borrower-projects_project-detail-link-icon'|trans }}"><span class="icon fa-eye-u16"></span></a></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                {% endif %}
                            </table>
                        </div>
                    </section><!-- /.ui-toggle-group -->
                </article><!-- /.panel -->
            </div><!-- /#profile-info.dashboard-tab-pane -->
        </div><!-- /.dashboard-tabs-content -->
    </div><!-- /.dashboard-tabs -->
{% endblock %}
