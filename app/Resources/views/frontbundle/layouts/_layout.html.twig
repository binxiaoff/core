{# Basic Page Layout #}

<!DOCTYPE html>
<!--[if lt IE 9]><html lang="{{ app.request.locale }}" class="lt-ie9 no-js"><![endif]-->
<!--[if IE 9]><html lang="{{ app.request.locale }}" class="ie9 no-js"><![endif]-->
<!--[if gt IE 9]><!--><html lang="{{ app.request.locale }}" class="no-js"><!--<![endif]-->
    <head {{ sonata_seo_head_attributes() }}>
        {{ google_tag_manager_head() }}
        {% block metaTags %}
            {{ sonata_seo_title() }}
            {{ sonata_seo_metadatas() }}
        {% endblock %}

        {% block cssFiles %}
            {% include 'partials/fonts_inline.html.twig' %}
            <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Cabin:400,700,400" media="all">

            {% if app.request.attributes.get('_route') in ['project_detail', 'projects_list', 'lender_projects'] %}
                {# Mapbox #}
                <link href="https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css" rel="stylesheet" />
                <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css" rel="stylesheet" />
                <link href="https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css" rel="stylesheet" />
            {% endif %}

            <link rel="stylesheet" href="{{ asset('css/screen.css', 'gulp') }}" />
            <!--[if lte IE 10]>
            <link rel="stylesheet" href="{{ asset('css/ie.css', 'gulp') }}" />
            <[endif]-->
        {% endblock %}

        <link rel="apple-touch-icon" sizes="180x180" href="{{ asset('favicons/apple-touch-icon.png', 'gulp') }}">
        <link rel="icon" type="image/png" href="{{ asset('favicons/favicon-32x32.png', 'gulp') }}" sizes="32x32">
        <link rel="icon" type="image/png" href="{{ asset('favicons/favicon-16x16.png', 'gulp') }}" sizes="16x16">
        <link rel="manifest" href="{{ asset('favicons/manifest.json', 'gulp') }}">
        <link rel="mask-icon" href="{{ asset('favicons/safari-pinned-tab.svg', 'gulp') }}" color="#b20066">
        <link rel="shortcut icon" href="{{ asset('favicons/favicon.ico', 'gulp') }}">
        <meta name="msapplication-config" content="{{ asset('favicons/browserconfig.xml', 'gulp') }}">
        <meta name="theme-color" content="#ffffff">

        {% block pageHeadScripts %}{% endblock %}
    </head>
    <body class="{% if app.user is defined and app.user is not empty %} ui-user-level-{{ lenderDiversificationLevel(app.user) }}{% if is_granted('ROLE_LENDER') %} ui-user-type-lender{% endif %}{% if is_granted('ROLE_BORROWER') %} ui-user-type-borrower{% endif %}{% if is_granted(constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\Clients::ROLE_PARTNER_DEFAULT')) %} ui-user-type-partner{% endif %}{% if is_granted(constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\Clients::ROLE_PARTNER_ADMIN')) %} ui-user-type-partner-admin{% endif %}{% if is_granted(constant('\\Unilend\\Bundle\\CoreBusinessBundle\\Entity\\Clients::ROLE_PARTNER_USER')) %} ui-user-type-partner-user{% endif %}{% else %} ui-no-user{% endif %}{% if bodyClassNames is defined %} {{ bodyClassNames }}{% endif %}">
        {{ google_tag_manager_body() }}
        <div id="top" class="site">
            {% block siteHeader %}
                {% if app.user is defined and is_granted('ROLE_LENDER') %}
                    {% include 'lender_account/connected_header.html.twig' %}
                {% elseif app.user is defined and is_granted('ROLE_BORROWER') %}
                    {% include 'borrower_account/connected_header.html.twig' %}
                {% elseif app.user is defined and is_granted('ROLE_PARTNER') %}
                    {% include 'partner_account/_connected_header.html.twig' %}
                {% else %}
                    {% include 'partials/header.html.twig' %}
                {%  endif %}
            {% endblock %}

            <div class="site-content">
                {% block siteContent %}
                {% endblock %}
            </div>

            {% block siteFooter %}
                {{ render(controller('UnilendFrontBundle:Main:footer', {'route': app.request.attributes.get('_route')})) }}
            {% endblock %}
        </div>

        {# Debug tools - Remove "and false" in order to display it #}
        {% if app.environment == 'dev' and false %}
            {% block debug %}
                {% include 'partials/debug.html.twig' %}
            {% endblock %}
        {% endif %}

        {# As long as lender menu is rendered using LenderAccount:lenderMenu, we need this trick before refactoring menu here and there #}
        {% if app.user is defined and app.user is not empty %}
            {% include 'partials/user_mobile_menu.html.twig' %}
        {% endif %}

        <div class="modal-spinner">
            <div id="floatingCirclesG">
                <div class="f_circleG" id="frotateG_01"></div>
                <div class="f_circleG" id="frotateG_02"></div>
                <div class="f_circleG" id="frotateG_03"></div>
                <div class="f_circleG" id="frotateG_04"></div>
                <div class="f_circleG" id="frotateG_05"></div>
                <div class="f_circleG" id="frotateG_06"></div>
                <div class="f_circleG" id="frotateG_07"></div>
                <div class="f_circleG" id="frotateG_08"></div>
            </div>
        </div>

        <div rel="templates" style="display:none" aria-hidden="true">
            {% block modals %}
                {# Place page-specific modals in this block and then use the `data-modal-toggle="#modal-id"` attribute on the anchor/button element you want to use to show it,
                   e.g. <a href="javascript:;" data-modal-toggle="#modal-tos">Open the TOS model</a> #}
            {% endblock %}

            {# Global site-wide modals can be placed here #}
            {% set tos_session_key = constant('Unilend\\Bundle\\CoreBusinessBundle\\Service\\TermsOfSaleManager::SESSION_KEY_TOS_ACCEPTED') %}
            {% if app.user
                and app.session.has(tos_session_key)
                and false == app.session.get(tos_session_key)
                and is_granted('ROLE_LENDER')
                and app.user.isValidated()
                and app.request.get('_route') != 'lenders_terms_of_sales'
            %}
                <div id="modal-tos" data-modal data-modal-openonload="true" data-modal-maxheight="550"><form id="form-tos" method="post" action="{{ path('lender_tos_popup') }}"></form></div>
            {% endif %}
        </div>

        {% block jsFiles %}
            <script type="text/javascript">
                {% set notifications = [] %}
                {% set lenderNotifications = lenderNotifications(app.user) %}
                {% if lenderNotifications is not empty %}
                    {% for notification in lenderNotifications %}
                        {% set notifications = notifications|merge([{
                            id: notification.id,
                            projectId: notification.projectId,
                            type: notification.type,
                            title: notification.title,
                            'iso-8601': notification.datetime|date('c'),
                            datetime: notification.datetime|localizeddate('medium', 'short'),
                            content: notification.content,
                            image: svgimage('#notification-' ~ notification.image, notification.title, 100, 100, 'none'),
                            status: notification.status
                        }]) %}
                    {% endfor %}
                {% endif %}

                var USERNOTIFICATIONS = JSON.parse('{{ notifications|json_encode|escape('js')|raw }}')

                var UTILITY_LANG = JSON.parse('{{ dictionary('utility')|json_encode|escape('js')|raw }}')
                var AUTOCOMPLETE_LANG = JSON.parse('{{ dictionary('auto-complete')|json_encode|escape('js')|raw }}')
                var FORMVALIDATION_LANG = JSON.parse('{{ dictionary('form-validation')|json_encode|escape('js')|raw }}')
                var PASSWORDCHECK_LANG = JSON.parse('{{ dictionary('password-check')|json_encode|escape('js')|raw }}')
                var SORTABLE_LANG = JSON.parse('{{ dictionary('sortable')|json_encode|escape('js')|raw }}')
                var FILEATTACH_LANG = JSON.parse('{{ dictionary('file-attach')|json_encode|escape('js')|raw }}')
                var USERNOTIFICATIONS_LANG = JSON.parse('{{ dictionary('lender-notifications')|json_encode|escape('js')|raw }}')

                {% if app.request.attributes.get('_route') in ['project_detail', 'projects_list', 'lender_projects'] %}
                    var MAPVIEW_LANG = JSON.parse('{{ dictionary('mapview')|json_encode|escape('js')|raw }}')
                {% endif %}

                {# Variables must be created here in order to set their visibility before main.js #}
                var onloadRecaptchaCallback = function () {}
                var onSubmitRecaptchaCallback = function () {}
                var onExpireRecaptchaCallback = function () {}
            </script>

            {% if app.request.attributes.get('_route') in ['project_detail', 'projects_list', 'lender_projects'] %}
                <script type="text/javascript" src="https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js"></script>
                <script type="text/javascript" src="https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
            {% endif %}

            <script type="text/javascript" src="{{ asset('js/dependencies.js', 'gulp') }}"></script>
            <script type="text/javascript" src="{{ asset('js/main.js', 'gulp') }}"></script>

            {% if recaptchaKey is defined and recaptchaKey is not empty %}
                <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptchaCallback&render=explicit" async defer></script>
            {% endif %}
        {% endblock %}

        {% block pageScripts %}{% endblock %}

        {{ google_tag_manager_body_end() }}
    </body>
</html>
